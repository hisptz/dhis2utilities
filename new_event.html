<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css" />
    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.4/build/jquery.datetimepicker.full.js">


    <!-- Bootstrap Date-Picker Plugin -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>
    <!-- https://test.hisptz.org/dhis/api/analytics/events/aggregate/Mvc0jfU9Ua2.json?stage=mlDzRw3ibhE&dimension=uochSI2xLGI:IN%3AO06%20-%20Abortion%3BO46%20-%20Antepartum%20Haemorrhage%3BO66%20-%20Obstructed%20Labour%3BO71%20-%20Rupture%20uterus%3BO72%20-%20Post-partum%20haemorrhage%3BO75%20-%20Local%20herbs%20in%20Pregnancy%3BO75%20-%20Unknown%20fever%3BO85%20-%20Puerperal%20Sepsis%20%2FSepticaemia%3BO98%20-%20Malaria%20in%20pregnancy%3BO99%20-%20Anaemia%20in%20Pregnancy%3BO99%20-%20Meningitis%3BO99%20-%20Pneumonia%20in%20pregnancy%3BO99.4%20-%20Cardiomyopathy%20in%20Pregnancy%3Beclampsia&dimension=JJkV68Devly&dimension=Swn04dN2EwP-sjYF2oeQTCv&dimension=pe:2014&dimension=ou:OU_GROUP-O4hfhLGzu8H;OU_GROUP-Y6oYSbQE2Tp;OU_GROUP-I326qTfkdwh;OU_GROUP-xlorplD1QwS;m0frOspS7JY&outputType=EVENT&displayProperty=NAME -->

    <style type="text/css">
        body,div,table,thead,tbody,tfoot,tr,th,td,p { font-family:"Arial"; font-size: 1em }
        a.comment-indicator:hover + comment { background:#ffd; position:absolute; display:block; border:1px solid black; padding:0.5em;  }
        a.comment-indicator { background:red; display:inline-block; border:1px solid black; width:0.5em; height:0.5em;  }
        comment { display:none;  }
        td {
            text-align: left; border: 1px solid black;
        }
        .disp_center {
            text-align: center; font-weight: 600;
        }
        .td_styles, .td_styles2 {
            border-top: 1px solid #000000;
        }
        table {
            border: 1px solid #000000;
        }
         .searchable-container{margin:2px 0 0 0}
        .searchable-container label.btn-default.active{background-color:#007ba7;color:#FFF}
        .searchable-container label.btn-default{width:90%;border:1px solid #efefef;margin:3px; box-shadow:5px 8px 8px 0 #ccc;}
        .searchable-container label .bizcontent{width:100%;}
        .searchable-container .btn-group{width:90%}
        .searchable-container .btn span.glyphicon{
            opacity: 0;
        }
        .searchable-container .btn.active span.glyphicon {
            opacity: 1;
        }

        span.multiselect-native-select {
            position: relative
        }
        span.multiselect-native-select select {
            border: 0!important;
            clip: rect(0 0 0 0)!important;
            height: 1px!important;
            margin: -1px -1px -1px -3px!important;
            overflow: hidden!important;
            padding: 0!important;
            position: absolute!important;
            width: 1px!important;
            left: 50%;
            top: 30px
        }
        .multiselect-container {
            position: absolute;
            list-style-type: none;
            margin: 0;
            padding: 0
        }
        .multiselect-container .input-group {
            margin: 5px
        }
        .multiselect-container>li {
            padding: 0
        }
        .multiselect-container>li>a.multiselect-all label {
            font-weight: 700
        }
        .multiselect-container>li.multiselect-group label {
            margin: 0;
            padding: 3px 20px 3px 20px;
            height: 100%;
            font-weight: 700
        }
        .multiselect-container>li.multiselect-group-clickable label {
            cursor: pointer
        }
        .multiselect-container>li>a {
            padding: 0
        }
        .multiselect-container>li>a>label {
            margin: 0;
            height: 100%;
            cursor: pointer;
            font-weight: 400;
            padding: 3px 0 3px 30px
        }
        .multiselect-container>li>a>label.radio, .multiselect-container>li>a>label.checkbox {
            margin: 0
        }
        .multiselect-container>li>a>label>input[type=checkbox] {
            margin-bottom: 5px
        }
        .btn-group>.btn-group:nth-child(2)>.multiselect.btn {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px
        }
        .form-inline .multiselect-container label.checkbox, .form-inline .multiselect-container label.radio {
            padding: 3px 20px 3px 40px
        }
        .form-inline .multiselect-container li a label.checkbox input[type=checkbox], .form-inline .multiselect-container li a label.radio input[type=radio] {
            margin-left: -20px;
            margin-right: 0
        }
    </style>

</head>

<body>
<script type="">
    $(document).ready(function() {

        $('.multiselect-ui').multiselect({
            onChange: function(option, checked) {
                // Get selected options.
                var selectedOptions = $('.multiselect-ui option:selected');

                if (selectedOptions.length >= 6) {
                    // Disable all other checkboxes.
                    var nonSelectedOptions = $('.multiselect-ui option').filter(function() {
                        return !$(this).is(':selected');
                    });

                    nonSelectedOptions.each(function() {
                        var input = $('input[value="' + $(this).val() + '"]');
                        input.prop('disabled', true);
                        input.parent('li').addClass('disabled');
                    });
                }
                else {
                    // Enable all checkboxes.
                    $('.multiselect-ui option').each(function() {
                        var input = $('input[value="' + $(this).val() + '"]');
                        input.prop('disabled', false);
                        input.parent('li').addClass('disabled');
                    });
                }
            }
        });

        $(function () {
            $(".datepicker").remove('style');
            $(".datepicker").css('top', '170px');
            $("#datepicker").datepicker();
        });

        var date_input = $('input[name="date"]'); //our date input has the name "date"
        var container = $('.bootstrap-iso form').length > 0 ? $('.bootstrap-iso form').parent() : "body";
        var options = {
            format: 'yyyy-mm-dd',
            container: container,
            todayHighlight: true,
            autoclose: true,
            orientation: "bottom auto"
        };
        date_input.datepicker(options);

        var eventData2 = {
            headers: [
                {
                    name: "uochSI2xLGI",
                    column: "Immediate Cause of Death",
                    type: "java.lang.String",
                    hidden: false,
                    meta: true,
                    optionSet: "TSa97I3hB5y"
                },
                {
                    name: "JJkV68Devly",
                    column: "Age Type",
                    type: "java.lang.String",
                    hidden: false,
                    meta: true,
                    optionSet: "oRhpnHF40ti"
                },
                {
                    name: "Swn04dN2EwP",
                    column: "Age",
                    type: "java.lang.Integer",
                    hidden: false,
                    meta: true,
                    legendSet: "sjYF2oeQTCv"
                },
                {
                    name: "ou",
                    column: "Organisation unit",
                    type: "java.lang.String",
                    hidden: false,
                    meta: true
                },
                {
                    name: "value",
                    column: "Value",
                    type: "java.lang.Double",
                    hidden: false,
                    meta: false
                }
            ],
            metaData: {
                names: {
                    2014: "2014",
                    Uc4q4WIA3H9: "Sumbawanga Reginal Hospital",
                    Nky82zx6NQw: "Mount Meru Hospital",
                    mlDzRw3ibhE: "Single-Event Death Registry",
                    TfPNO5HfV48: "1-5",
                    uochSI2xLGI: "Immediate Cause of Death",
                    MYbdCaXtKeD: "5-60",
                    Swn04dN2EwP: "Age",
                    BmsnwOaYcmZ: "Tumbi Hospital",
                    qmdW6OHhPDT: "60+",
                    sTnafXMjP2d: "Manyara Regional Hospital",
                    j92vRz8NTmk: "Ruvuma Regional Hospital",
                    G4g9PzrsMLh: "Maweni Hospital",
                    wcKDOsEFzmE: "Ligula Regional Hospital",
                    UJVrLWcFnQW: "Bombo Regional Hospital",
                    ou: "Organisation unit",
                    R3oV1QyOPyR: "Dodoma Regional Hospital",
                    rImF6zIqpn9: "Temeke Hospital",
                    iOyC6kkyHAw: "Morogoro Regional Referral Hospital",
                    UFWYvkqXX89: "Tabora (Kitete) Hospital",
                    pnqOQbyMTFv: "0-1",
                    qjdrnCtCgSC: "Singida Regional Hospital",
                    aeZRkF0OVFK: "Sokoine Regional Hospital",
                    ymiIhszR6dn: "Mwananyamala Hospital",
                    Mvc0jfU9Ua2: "Death Registry",
                    VduMoQ0SKc6: "Mbeya Regional Hospital",
                    lKAxm7dimju: "Mawenzi Hospital",
                    pe: "Period",
                    JJkV68Devly: "Age Type",
                    V0ooymSqezW: "Iringa Hospital",
                    NnLWC4MW7ix: "Seko Toure Regional Hospital",
                    dByxc7pczz4: "Shinyanga Regional Regional Referral Hospital",
                    GRDYT0QagNn: "Amana Hospital - Regional Referral Hospital",
                    PAARXcHWGq0: "Mara Region Hospital",
                    qbvm0hcQ0Nw: "Bukoba Regional Referral Hospital"
                },
                pe: [
                    "2014"
                ],
                ou: [
                    "GRDYT0QagNn",
                    "UJVrLWcFnQW",
                    "qbvm0hcQ0Nw",
                    "R3oV1QyOPyR",
                    "V0ooymSqezW",
                    "wcKDOsEFzmE",
                    "sTnafXMjP2d",
                    "PAARXcHWGq0",
                    "G4g9PzrsMLh",
                    "lKAxm7dimju",
                    "VduMoQ0SKc6",
                    "iOyC6kkyHAw",
                    "Nky82zx6NQw",
                    "ymiIhszR6dn",
                    "j92vRz8NTmk",
                    "NnLWC4MW7ix",
                    "dByxc7pczz4",
                    "qjdrnCtCgSC",
                    "aeZRkF0OVFK",
                    "Uc4q4WIA3H9",
                    "UFWYvkqXX89",
                    "rImF6zIqpn9",
                    "BmsnwOaYcmZ"
                ]
            },
            height: 103,
            rows: [
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "j92vRz8NTmk",
                    "1"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "qbvm0hcQ0Nw",
                    "3"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "qmdW6OHhPDT",
                    "UFWYvkqXX89",
                    "1"
                ],
                [
                    "O75 - Local herbs in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "PAARXcHWGq0",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "TfPNO5HfV48",
                    "aeZRkF0OVFK",
                    "1"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "ymiIhszR6dn",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "TfPNO5HfV48",
                    "GRDYT0QagNn",
                    "7"
                ],
                [
                    "O99 - Pulmonary oedema",
                    "Years",
                    "qmdW6OHhPDT",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Days",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "18"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "TfPNO5HfV48",
                    "rImF6zIqpn9",
                    "2"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Days",
                    "pnqOQbyMTFv",
                    "ymiIhszR6dn",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "ymiIhszR6dn",
                    "2"
                ],
                [
                    "O06 - Abortion",
                    "Hours",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "5"
                ],
                [
                    "O98 - Malaria in pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "G4g9PzrsMLh",
                    "2"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "TfPNO5HfV48",
                    "rImF6zIqpn9",
                    "1"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "pnqOQbyMTFv",
                    "ymiIhszR6dn",
                    "1"
                ],
                [
                    "O99 - Pneumonia in pregnancy",
                    "Years",
                    "TfPNO5HfV48",
                    "qbvm0hcQ0Nw",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Months",
                    "TfPNO5HfV48",
                    "UFWYvkqXX89",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "aeZRkF0OVFK",
                    "3"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Days",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "14"
                ],
                [
                    "O71 - Rupture uterus",
                    "Days",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O98 - Malaria in pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "2"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "193"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "qmdW6OHhPDT",
                    "Nky82zx6NQw",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "Nky82zx6NQw",
                    "4"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "",
                    "lKAxm7dimju",
                    "2"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "UFWYvkqXX89",
                    "2"
                ],
                [
                    "O66 - Obstructed Labour",
                    "Years",
                    "MYbdCaXtKeD",
                    "UFWYvkqXX89",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "rImF6zIqpn9",
                    "13"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "qmdW6OHhPDT",
                    "V0ooymSqezW",
                    "2"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "2"
                ],
                [
                    "O66 - Obstructed Labour",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "G4g9PzrsMLh",
                    "1"
                ],
                [
                    "O75 - Local herbs in Pregnancy",
                    "Days",
                    "TfPNO5HfV48",
                    "Uc4q4WIA3H9",
                    "1"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "qmdW6OHhPDT",
                    "V0ooymSqezW",
                    "1"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "lKAxm7dimju",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "lKAxm7dimju",
                    "1"
                ],
                [
                    "O46 - Antepartum Haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "4"
                ],
                [
                    "O06 - Abortion",
                    "Days",
                    "pnqOQbyMTFv",
                    "ymiIhszR6dn",
                    "41"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Days",
                    "TfPNO5HfV48",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "lKAxm7dimju",
                    "3"
                ],
                [
                    "O66 - Obstructed Labour",
                    "Years",
                    "MYbdCaXtKeD",
                    "UJVrLWcFnQW",
                    "2"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "UJVrLWcFnQW",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Days",
                    "TfPNO5HfV48",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Days",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Hours",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "2"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Days",
                    "TfPNO5HfV48",
                    "ymiIhszR6dn",
                    "1"
                ],
                [
                    "O06 - Abortion",
                    "Days",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "29"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Months",
                    "MYbdCaXtKeD",
                    "G4g9PzrsMLh",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "sTnafXMjP2d",
                    "1"
                ],
                [
                    "O98 - Malaria in pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "dByxc7pczz4",
                    "1"
                ],
                [
                    "O99 - Pneumonia in pregnancy",
                    "Days",
                    "MYbdCaXtKeD",
                    "qbvm0hcQ0Nw",
                    "2"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "ymiIhszR6dn",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Days",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "qbvm0hcQ0Nw",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Days",
                    "TfPNO5HfV48",
                    "GRDYT0QagNn",
                    "2"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "qmdW6OHhPDT",
                    "PAARXcHWGq0",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "V0ooymSqezW",
                    "1"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "V0ooymSqezW",
                    "84"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "aeZRkF0OVFK",
                    "2"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "V0ooymSqezW",
                    "83"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "aeZRkF0OVFK",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "qmdW6OHhPDT",
                    "GRDYT0QagNn",
                    "87"
                ],
                [
                    "O75 - Unknown fever",
                    "Months",
                    "TfPNO5HfV48",
                    "GRDYT0QagNn",
                    "3"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "rImF6zIqpn9",
                    "3"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "UFWYvkqXX89",
                    "2"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "dByxc7pczz4",
                    "1"
                ],
                [
                    "O71 - Rupture uterus",
                    "Years",
                    "MYbdCaXtKeD",
                    "UFWYvkqXX89",
                    "1"
                ],
                [
                    "O72 - Post-partum haemorrhage",
                    "Years",
                    "MYbdCaXtKeD",
                    "ymiIhszR6dn",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "UFWYvkqXX89",
                    "1"
                ],
                [
                    "O98 - Malaria in pregnancy",
                    "Years",
                    "qmdW6OHhPDT",
                    "G4g9PzrsMLh",
                    "1"
                ],
                [
                    "O66 - Obstructed Labour",
                    "Days",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "dByxc7pczz4",
                    "4"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "qjdrnCtCgSC",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Months",
                    "MYbdCaXtKeD",
                    "GRDYT0QagNn",
                    "5"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "TfPNO5HfV48",
                    "UFWYvkqXX89",
                    "2"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Months",
                    "MYbdCaXtKeD",
                    "aeZRkF0OVFK",
                    "2"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "UJVrLWcFnQW",
                    "1"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "PAARXcHWGq0",
                    "1"
                ],
                [
                    "O06 - Abortion",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "1"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "dByxc7pczz4",
                    "3"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "MYbdCaXtKeD",
                    "PAARXcHWGq0",
                    "13"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "2"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "lKAxm7dimju",
                    "1"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "PAARXcHWGq0",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "V0ooymSqezW",
                    "239"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "TfPNO5HfV48",
                    "V0ooymSqezW",
                    "1"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "G4g9PzrsMLh",
                    "2"
                ],
                [
                    "O99 - Pneumonia in pregnancy",
                    "Days",
                    "qmdW6OHhPDT",
                    "qbvm0hcQ0Nw",
                    "1"
                ],
                [
                    "O75 - Local herbs in Pregnancy",
                    "Days",
                    "pnqOQbyMTFv",
                    "GRDYT0QagNn",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "",
                    "GRDYT0QagNn",
                    "2"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "lKAxm7dimju",
                    "2"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "TfPNO5HfV48",
                    "PAARXcHWGq0",
                    "6"
                ],
                [
                    "O66 - Obstructed Labour",
                    "Years",
                    "MYbdCaXtKeD",
                    "qbvm0hcQ0Nw",
                    "1"
                ],
                [
                    "O75 - Unknown fever",
                    "Years",
                    "MYbdCaXtKeD",
                    "V0ooymSqezW",
                    "6"
                ],
                [
                    "O99.4 - Cardiomyopathy in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "G4g9PzrsMLh",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "Uc4q4WIA3H9",
                    "1"
                ],
                [
                    "O99 - Anaemia in Pregnancy",
                    "Years",
                    "MYbdCaXtKeD",
                    "PAARXcHWGq0",
                    "1"
                ],
                [
                    "O85 - Puerperal Sepsis /Septicaemia",
                    "Years",
                    "MYbdCaXtKeD",
                    "V0ooymSqezW",
                    "2"
                ]
            ],
            width: 5
        };

        $('.datepicker').css('top', '200px !important');

        var orgUnit = dhis2.report.organisationUnit;
        var periods = dhis2.report.periods;

        $('#orgName').append('<input type="hidden" id="orgNameInputId" value="'+orgUnit.name+'">');
        $('#orgId').append('<input type="hidden" id="orgInputId" value="'+orgUnit.id+'">');

        var eventUrl = 'https://dhis.moh.go.tz/api/analytics/events/aggregate/Mvc0jfU9Ua2.json?stage=mlDzRw3ibhE&dimension=uochSI2xLGI:IN%3AO06%20-%20Abortion%3BO46%20-%20Antepartum%20Haemorrhage%3BO66%20-%20Obstructed%20Labour%3BO71%20-%20Rupture%20uterus%3BO72%20-%20Post-partum%20haemorrhage%3BO75%20-%20Local%20herbs%20in%20Pregnancy%3BO75%20-%20Unknown%20fever%3BO85%20-%20Puerperal%20Sepsis%20%2FSepticaemia%3BO98%20-%20Malaria%20in%20pregnancy%3BO99%20-%20Anaemia%20in%20Pregnancy%3BO99%20-%20Meningitis%3BO99%20-%20Pneumonia%20in%20pregnancy%3BO99%20-%20Pulmonary%20oedema%3BO99.4%20-%20Cardiomyopathy%20in%20Pregnancy%3Beclampsia&dimension=JJkV68Devly&dimension=Swn04dN2EwP-sjYF2oeQTCv&dimension=ou:OU_GROUP-Y6oYSbQE2Tp;'+orgUnit.id+'&filter=pe:'+periods[0]+'&outputType=EVENT&displayProperty=NAME'
        $.getJSON(eventUrl, function (response) {
            var eventData = response;

            $('#heading').append('<p id="top-heading">MINISTRY OF HEALTH COMMUNITY DEVELOPMENT GENDER ELDERLY AND CHILDREN ( ' + orgUnit.name + ' ) FOR ' + eventData.metaData.pe + '</p>');

        var ageTypes = ['Years', 'Months', 'Days', 'Hours'];
        var ages = ['0-1', '1-5', '5-60','60+'];

        var orgUnits = []; var diseasesArr = []; var orgDiseaseAgeTypeAgeValue ='';
        eventData.metaData.ou.forEach(function (orgUID, index) {
            orgUnits.push(eventData.metaData.names[orgUID]);
        });

        var disCheckStr ='';
        eventData.rows.forEach(function (row, index) {
            if (disCheckStr.indexOf(row[0]) < 0) {
                disCheckStr += row[0];
                diseasesArr.push(row[0]);
            }
        });

        orgUnits.forEach(function (orgUnitName, index) {
            if (orgUnitName){
                var tr = '<td>'+ (index+1)+'</td>'+'<td style="width: 30%">'+ orgUnitName + '</td>';
                diseasesArr.forEach(function (disease, index) {
                    ageTypes.forEach(function (ageType, index) {
                        var testStr = '';
                        ages.forEach(function (age, index) {
                            var myTd = '';
                            if (age === '0-1') {
                                eventData.rows.forEach(function (row, i) {
                                    if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '0-1' && row[1] === ageType) {
                                        myTd += '<td>'+row[4]+'</td>';
                                    }
                                });
                            } else if (age === '1-5') {
                                eventData.rows.forEach(function (row, i) {
                                    if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '1-5' && row[1] === ageType) {
                                        myTd += '<td>'+row[4]+'</td>';
                                    }
                                });
                            } else if (age === '5-60') {
                                eventData.rows.forEach(function (row, i) {
                                    if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '5-60' && row[1] === ageType) {
                                        myTd += '<td>'+row[4]+'</td>';
                                    }
                                });
                            } else if (age === '60+') {
                                eventData.rows.forEach(function (row, i) {
                                    if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '60+' && row[1] === ageType) {
                                        myTd += '<td>'+row[4]+'</td>';
                                    }
                                });
                            }
                            if (myTd.length === 0) {
                                tr += '<td>'+' '+'</td>';
                                testStr += 'JOSE';
                            } else{
                                tr += myTd;
                            }
                        });
                    });
                });
                $('#example').append('<tr class="row_values">'+tr+'</tr>');
            }
        });

        var diseases = ''; var periods = '';  var ageTypes = ''; var theAges = '';
        diseasesArr.forEach(function (disease, index) {
            diseases += '<td class="td_styles2" colspan=16 style="text-align: center;" valign=bottom>' + disease + '</td>';
            periods += '<td class="td_styles2" colspan=16 align="center" valign=bottom>' + eventData.metaData.pe+ '</td>';
            ageTypes += '<td class="td_styles2" colspan=4 align="left" valign=bottom>Years</td>' +
                '<td  class="td_styles2" colspan=4 align="left" valign=bottom>Months</td>'+
                '<td  class="td_styles2" colspan=4 align="left" valign=bottom>Days</td>'+
                '<td  class="td_styles2" colspan=4 align="left" valign=bottom>Hours</td>';

            for (var count = 0; count < 4; count++) {
                ages.forEach(function (age, index) {
                    theAges += '<td  class="td_styles2" align="left" valign=bottom>'+ age+'</td>';
                });
            }
        });
            $('#disease_row').append(diseases);
            $('#period').append(periods);
            $('#age_types').append(ageTypes);
            $('#ages').append(theAges);

        });

        $("#btnExport").click(function (e) {
            e.preventDefault();

            //getting data from our table
            var data_type = 'data:application/vnd.ms-excel';
            var table_div = document.getElementById('downloadable_table');
            var table_html = table_div.outerHTML.replace(/ /g, '%20');

            var a = document.createElement('a');
            a.href = data_type + ', ' + table_html;
            a.download = 'exported_table_' + Math.floor((Math.random() * 9999999) + 1000000) + '.xls';
            a.click();
        });

        $('#report-btn').click(function (e) {
            var opts = [];
            $(':selected').each(function () {
                opts.push(this.value);
            });
            var orgGroupStr = '';
            opts.forEach(function (uid, index) {
                orgGroupStr += 'OU_GROUP-'+ uid + ';';
            });

            $('.row_values').remove();
            $('.td_styles2').remove();
            $('#top-heading').remove();

            var orgName = $('#orgNameInputId').val();
            var orgId = $('#orgInputId').val();

            var eventUrl = 'https://dhis.moh.go.tz/api/analytics/events/aggregate/Mvc0jfU9Ua2.json?stage=mlDzRw3ibhE&dimension=uochSI2xLGI:IN%3AO06%20-%20Abortion%3BO46%20-%20Antepartum%20Haemorrhage%3BO66%20-%20Obstructed%20Labour%3BO71%20-%20Rupture%20uterus%3BO72%20-%20Post-partum%20haemorrhage%3BO75%20-%20Local%20herbs%20in%20Pregnancy%3BO75%20-%20Unknown%20fever%3BO85%20-%20Puerperal%20Sepsis%20%2FSepticaemia%3BO98%20-%20Malaria%20in%20pregnancy%3BO99%20-%20Anaemia%20in%20Pregnancy%3BO99%20-%20Meningitis%3BO99%20-%20Pneumonia%20in%20pregnancy%3BO99%20-%20Pulmonary%20oedema%3BO99.4%20-%20Cardiomyopathy%20in%20Pregnancy%3Beclampsia&dimension=JJkV68Devly&dimension=Swn04dN2EwP-sjYF2oeQTCv&dimension=ou:' + orgGroupStr + orgId + '&filter=pe:'+ periods[0]+'&outputType=EVENT&displayProperty=NAME'

            $.getJSON(eventUrl, function (response) {
                var eventData = response;

                $('#heading').append('<p id="top-heading">MINISTRY OF HEALTH COMMUNITY DEVELOPMENT GENDER ELDERLY AND CHILDREN ( ' + orgName + ' ) FOR ' + eventData.metaData.pe + '</p>');

                var ageTypes = ['Years', 'Months', 'Days', 'Hours'];
                var ages = ['0-1', '1-5', '5-60','60+'];

                var orgUnits = []; var diseasesArr = []; var orgDiseaseAgeTypeAgeValue ='';
                eventData.metaData.ou.forEach(function (orgUID, index) {
                    orgUnits.push(eventData.metaData.names[orgUID]);
                });

                var disCheckStr ='';
                eventData.rows.forEach(function (row, index) {
                    if (disCheckStr.indexOf(row[0]) < 0) {
                        disCheckStr += row[0];
                        diseasesArr.push(row[0]);
                    }
                });

                orgUnits.forEach(function (orgUnitName, index) {
                    if (orgUnitName){
                        var tr = '<td>'+ (index+1)+'</td>'+'<td style="width: 30%">'+ orgUnitName + '</td>';
                        diseasesArr.forEach(function (disease, index) {
                            ageTypes.forEach(function (ageType, index) {
                                var testStr = '';
                                ages.forEach(function (age, index) {
                                    var myTd = '';
                                    if (age === '0-1') {
                                        eventData.rows.forEach(function (row, i) {
                                            if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '0-1' && row[1] === ageType) {
                                                myTd += '<td>'+row[4]+'</td>';
                                            }
                                        });
                                    } else if (age === '1-5') {
                                        eventData.rows.forEach(function (row, i) {
                                            if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '1-5' && row[1] === ageType) {
                                                myTd += '<td>'+row[4]+'</td>';
                                            }
                                        });
                                    } else if (age === '5-60') {
                                        eventData.rows.forEach(function (row, i) {
                                            if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '5-60' && row[1] === ageType) {
                                                myTd += '<td>'+row[4]+'</td>';
                                            }
                                        });
                                    } else if (age === '60+') {
                                        eventData.rows.forEach(function (row, i) {
                                            if (eventData.metaData.names[row[3]] === orgUnitName && row[0] === disease && eventData.metaData.names[row[2]] === '60+' && row[1] === ageType) {
                                                myTd += '<td>'+row[4]+'</td>';
                                            }
                                        });
                                    }
                                    if (myTd.length === 0) {
                                        tr += '<td>'+' '+'</td>';
                                        testStr += 'JOSE';
                                    } else{
                                        tr += myTd;
                                    }
                                });
                            });
                        });
                        $('#example').append('<tr class="row_values">'+tr+'</tr>');
                    }
                });

                var diseases = ''; var periods = '';  var ageTypes = ''; var theAges = '';
                diseasesArr.forEach(function (disease, index) {
                    diseases += '<td class="td_styles2" colspan=16 style="text-align: center;" valign=bottom>' + disease + '</td>';
                    periods += '<td class="td_styles2" colspan=16 align="center" valign=bottom>' + eventData.metaData.pe+ '</td>';
                    ageTypes += '<td class="td_styles2" colspan=4 align="left" valign=bottom>Years</td>' +
                        '<td  class="td_styles2" colspan=4 align="left" valign=bottom>Months</td>'+
                        '<td  class="td_styles2" colspan=4 align="left" valign=bottom>Days</td>'+
                        '<td  class="td_styles2" colspan=4 align="left" valign=bottom>Hours</td>';

                    for (var count = 0; count < 4; count++) {
                        ages.forEach(function (age, index) {
                            theAges += '<td  class="td_styles2" align="left" valign=bottom>'+ age+'</td>';
                        });
                    }
                });

                $('#disease_row').append(diseases);
                $('#period').append(periods);
                $('#age_types').append(ageTypes);
                $('#ages').append(theAges);


            });
        });

    });
</script>
<div class="container">
    <div class="row">
        <div class="col-md-1">
            <h4> OrgUnit Groups</h4>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <div class="row">
                    <select id="dates-field2" class="multiselect-ui form-control" multiple="multiple">
                        <!--<option value="O4hfhLGzu8H">Regional Referral Hospital</option>-->
                        <!--<option value="tnz6uusQqSf">Other Hospital</option>-->
                        <!--<option value="rHjr1oAqSIS">National Super Specialist Hospital</option>-->
                        <!--<option value="P9dlUDycTwP">National Hospital</option>-->
                        <option value="vjpk1xfww5z">RBF Facilities</option>
                        <option value="Y6oYSbQE2Tp">Regional Hospitals</option>
                        <option value="pL1tjNtxv7Z">RBF RHCMTs,CHMTS and Hospitals</option>
                        <!--<option value="xlorplD1QwS">Referral Hospital</option>-->
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <input id="report-btn" type="button" class="btn btn-primary"  value="Get Report">
        </div>
        <div class="col-md-6"></div>
    </div>
</div>
<div class="">
    <div class='row'>
        <div class='col-md-12' id="heading" style='text-align:center;font-weight:bolder;'></div>
        <div class='col-md-12' id="icon">
            <div class='row' style='text-align:center;'>
                <div class='col-md-5'>
                </div>
                <div class='col-md-2'>
                    <a href='#' class='thumbnail'
                       style='width:50px!important;padding:10px;font-weight:bolder;position:relative;margin: auto;top: 0;left: 0;right: 0;bottom: 0;border: 0px solid #ffffff!important;border-radius: 0px!important;-webkit-box-shadow: 0 0px 0px rgba(0,0,0,.075)!important;box-shadow: 0 0px 0px rgba(0,0,0,.075)!important;'><img
                            class=''
                            src='https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Coat_of_arms_of_Tanzania.svg/30px-Coat_of_arms_of_Tanzania.svg.png'/></a>
                </div>
                <div class='col-md-5'>
                </div>
            </div>
        </div>
        <div class='col-md-12' id="sub-heading" style='text-align:center;font-weight:bolder;'> <p> DEATH REGISTRY REPORT</p></div>
    </div>
    <div  class="row">
        <button id="btnExport" class="pull-left" style="margin-right: 28px;">Download as Excel</button>
    </div>
    <div class="row" id="downloadable_table">
        <table  class="table table-striped table-bordered" cellspacing="0" width="100%" id="example">
            <tr id="disease_row" style="background-color: #7FC9FD; font-weight: 600; font-size: 1.1em;">
                <td class="td_styles" rowspan=4 height="74" align="center" valign=bottom><b><font>#</font></b></td>
                <td style="width: 30%;" class="td_styles"><b><font>Intermediate cause of Death</font></b></td>
            </tr>
            <tr id="period" style="background-color: #7FC9FD; font-weight: 600; font-size: 1.1em;">
                <td style="" align="left"><b><font>Period</font></b></td>
            </tr>
            <tr id="age_types" style="background-color: #7FC9FD; font-weight: 600; font-size: 1.1em;">
                <td align="left"><b><font>Age Type</font></b></td>
            </tr>
            <tr id="ages" style="background-color: #7FC9FD; font-weight: 600; font-size: 1.1em;">
                <td  align="left"><b><font>Organisation Unit/Age</font></b></td>
            </tr>
        </table>
    </div>
</div>
<div class="row">
    <div id="orgName"></div>
    <div id="orgId"></div>
</div>
<script type="text/javascript">
    /**
     * Bootstrap Multiselect (https://github.com/davidstutz/bootstrap-multiselect)
     *
     * Apache License, Version 2.0:
     * Copyright (c) 2012 - 2015 David Stutz
     *
     * Licensed under the Apache License, Version 2.0 (the "License"); you may not
     * use this file except in compliance with the License. You may obtain a
     * copy of the License at http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
     * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
     * License for the specific language governing permissions and limitations
     * under the License.
     *
     * BSD 3-Clause License:
     * Copyright (c) 2012 - 2015 David Stutz
     * All rights reserved.
     *
     * Redistribution and use in source and binary forms, with or without
     * modification, are permitted provided that the following conditions are met:
     *    - Redistributions of source code must retain the above copyright notice,
     *      this list of conditions and the following disclaimer.
     *    - Redistributions in binary form must reproduce the above copyright notice,
     *      this list of conditions and the following disclaimer in the documentation
     *      and/or other materials provided with the distribution.
     *    - Neither the name of David Stutz nor the names of its contributors may be
     *      used to endorse or promote products derived from this software without
     *      specific prior written permission.
     *
     * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
     * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
     * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
     * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
     * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
     * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
     * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
     * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
     * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
     * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
     * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
     */
    !function ($) {
        "use strict";// jshint ;_;

        if (typeof ko !== 'undefined' && ko.bindingHandlers && !ko.bindingHandlers.multiselect) {
            ko.bindingHandlers.multiselect = {
                after: ['options', 'value', 'selectedOptions', 'enable', 'disable'],

                init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
                    var $element = $(element);
                    var config = ko.toJS(valueAccessor());

                    $element.multiselect(config);

                    if (allBindings.has('options')) {
                        var options = allBindings.get('options');
                        if (ko.isObservable(options)) {
                            ko.computed({
                                read: function() {
                                    options();
                                    setTimeout(function() {
                                        var ms = $element.data('multiselect');
                                        if (ms)
                                            ms.updateOriginalOptions();//Not sure how beneficial this is.
                                        $element.multiselect('rebuild');
                                    }, 1);
                                },
                                disposeWhenNodeIsRemoved: element
                            });
                        }
                    }

                    //value and selectedOptions are two-way, so these will be triggered even by our own actions.
                    //It needs some way to tell if they are triggered because of us or because of outside change.
                    //It doesn't loop but it's a waste of processing.
                    if (allBindings.has('value')) {
                        var value = allBindings.get('value');
                        if (ko.isObservable(value)) {
                            ko.computed({
                                read: function() {
                                    value();
                                    setTimeout(function() {
                                        $element.multiselect('refresh');
                                    }, 1);
                                },
                                disposeWhenNodeIsRemoved: element
                            }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                        }
                    }

                    //Switched from arrayChange subscription to general subscription using 'refresh'.
                    //Not sure performance is any better using 'select' and 'deselect'.
                    if (allBindings.has('selectedOptions')) {
                        var selectedOptions = allBindings.get('selectedOptions');
                        if (ko.isObservable(selectedOptions)) {
                            ko.computed({
                                read: function() {
                                    selectedOptions();
                                    setTimeout(function() {
                                        $element.multiselect('refresh');
                                    }, 1);
                                },
                                disposeWhenNodeIsRemoved: element
                            }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                        }
                    }

                    var setEnabled = function (enable) {
                        setTimeout(function () {
                            if (enable)
                                $element.multiselect('enable');
                            else
                                $element.multiselect('disable');
                        });
                    };

                    if (allBindings.has('enable')) {
                        var enable = allBindings.get('enable');
                        if (ko.isObservable(enable)) {
                            ko.computed({
                                read: function () {
                                    setEnabled(enable());
                                },
                                disposeWhenNodeIsRemoved: element
                            }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                        } else {
                            setEnabled(enable);
                        }
                    }

                    if (allBindings.has('disable')) {
                        var disable = allBindings.get('disable');
                        if (ko.isObservable(disable)) {
                            ko.computed({
                                read: function () {
                                    setEnabled(!disable());
                                },
                                disposeWhenNodeIsRemoved: element
                            }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                        } else {
                            setEnabled(!disable);
                        }
                    }

                    ko.utils.domNodeDisposal.addDisposeCallback(element, function() {
                        $element.multiselect('destroy');
                    });
                },

                update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
                    var $element = $(element);
                    var config = ko.toJS(valueAccessor());

                    $element.multiselect('setOptions', config);
                    $element.multiselect('rebuild');
                }
            };
        }

        function forEach(array, callback) {
            for (var index = 0; index < array.length; ++index) {
                callback(array[index], index);
            }
        }

        /**
         * Constructor to create a new multiselect using the given select.
         *
         * @param {jQuery} select
         * @param {Object} options
         * @returns {Multiselect}
         */
        function Multiselect(select, options) {

            this.$select = $(select);
            this.options = this.mergeOptions($.extend({}, options, this.$select.data()));

            // Placeholder via data attributes
            if (this.$select.attr("data-placeholder")) {
                this.options.nonSelectedText = this.$select.data("placeholder");
            }

            // Initialization.
            // We have to clone to create a new reference.
            this.originalOptions = this.$select.clone()[0].options;
            this.query = '';
            this.searchTimeout = null;
            this.lastToggledInput = null;

            this.options.multiple = this.$select.attr('multiple') === "multiple";
            this.options.onChange = $.proxy(this.options.onChange, this);
            this.options.onSelectAll = $.proxy(this.options.onSelectAll, this);
            this.options.onDeselectAll = $.proxy(this.options.onDeselectAll, this);
            this.options.onDropdownShow = $.proxy(this.options.onDropdownShow, this);
            this.options.onDropdownHide = $.proxy(this.options.onDropdownHide, this);
            this.options.onDropdownShown = $.proxy(this.options.onDropdownShown, this);
            this.options.onDropdownHidden = $.proxy(this.options.onDropdownHidden, this);
            this.options.onInitialized = $.proxy(this.options.onInitialized, this);
            this.options.onFiltering = $.proxy(this.options.onFiltering, this);

            // Build select all if enabled.
            this.buildContainer();
            this.buildButton();
            this.buildDropdown();
            this.buildSelectAll();
            this.buildDropdownOptions();
            this.buildFilter();

            this.updateButtonText();
            this.updateSelectAll(true);

            if (this.options.enableClickableOptGroups && this.options.multiple) {
                this.updateOptGroups();
            }

            this.options.wasDisabled = this.$select.prop('disabled');
            if (this.options.disableIfEmpty && $('option', this.$select).length <= 0) {
                this.disable();
            }

            this.$select.wrap('<span class="multiselect-native-select" />').after(this.$container);
            this.options.onInitialized(this.$select, this.$container);
        }

        Multiselect.prototype = {

            defaults: {
                /**
                 * Default text function will either print 'None selected' in case no
                 * option is selected or a list of the selected options up to a length
                 * of 3 selected options.
                 *
                 * @param {jQuery} options
                 * @param {jQuery} select
                 * @returns {String}
                 */
                buttonText: function(options, select) {
                    if (this.disabledText.length > 0
                        && (select.prop('disabled') || (options.length == 0 && this.disableIfEmpty)))  {

                        return this.disabledText;
                    }
                    else if (options.length === 0) {
                        return this.nonSelectedText;
                    }
                    else if (this.allSelectedText
                        && options.length === $('option', $(select)).length
                        && $('option', $(select)).length !== 1
                        && this.multiple) {

                        if (this.selectAllNumber) {
                            return this.allSelectedText + ' (' + options.length + ')';
                        }
                        else {
                            return this.allSelectedText;
                        }
                    }
                    else if (options.length > this.numberDisplayed) {
                        return options.length + ' ' + this.nSelectedText;
                    }
                    else {
                        var selected = '';
                        var delimiter = this.delimiterText;

                        options.each(function() {
                            var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).text();
                            selected += label + delimiter;
                        });

                        return selected.substr(0, selected.length - this.delimiterText.length);
                    }
                },
                /**
                 * Updates the title of the button similar to the buttonText function.
                 *
                 * @param {jQuery} options
                 * @param {jQuery} select
                 * @returns {@exp;selected@call;substr}
                 */
                buttonTitle: function(options, select) {
                    if (options.length === 0) {
                        return this.nonSelectedText;
                    }
                    else {
                        var selected = '';
                        var delimiter = this.delimiterText;

                        options.each(function () {
                            var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).text();
                            selected += label + delimiter;
                        });
                        return selected.substr(0, selected.length - this.delimiterText.length);
                    }
                },
                checkboxName: function(option) {
                    return false; // no checkbox name
                },
                /**
                 * Create a label.
                 *
                 * @param {jQuery} element
                 * @returns {String}
                 */
                optionLabel: function(element){
                    return $(element).attr('label') || $(element).text();
                },
                /**
                 * Create a class.
                 *
                 * @param {jQuery} element
                 * @returns {String}
                 */
                optionClass: function(element) {
                    return $(element).attr('class') || '';
                },
                /**
                 * Triggered on change of the multiselect.
                 *
                 * Not triggered when selecting/deselecting options manually.
                 *
                 * @param {jQuery} option
                 * @param {Boolean} checked
                 */
                onChange : function(option, checked) {

                },
                /**
                 * Triggered when the dropdown is shown.
                 *
                 * @param {jQuery} event
                 */
                onDropdownShow: function(event) {

                },
                /**
                 * Triggered when the dropdown is hidden.
                 *
                 * @param {jQuery} event
                 */
                onDropdownHide: function(event) {

                },
                /**
                 * Triggered after the dropdown is shown.
                 *
                 * @param {jQuery} event
                 */
                onDropdownShown: function(event) {

                },
                /**
                 * Triggered after the dropdown is hidden.
                 *
                 * @param {jQuery} event
                 */
                onDropdownHidden: function(event) {

                },
                /**
                 * Triggered on select all.
                 */
                onSelectAll: function() {

                },
                /**
                 * Triggered on deselect all.
                 */
                onDeselectAll: function() {

                },
                /**
                 * Triggered after initializing.
                 *
                 * @param {jQuery} $select
                 * @param {jQuery} $container
                 */
                onInitialized: function($select, $container) {

                },
                /**
                 * Triggered on filtering.
                 *
                 * @param {jQuery} $filter
                 */
                onFiltering: function($filter) {

                },
                enableHTML: false,
                buttonClass: 'btn btn-default',
                inheritClass: false,
                buttonWidth: 'auto',
                buttonContainer: '<div class="" />',
                dropRight: false,
                dropUp: false,
                selectedClass: 'active',
                // Maximum height of the dropdown menu.
                // If maximum height is exceeded a scrollbar will be displayed.
                maxHeight: false,
                includeSelectAllOption: false,
                includeSelectAllIfMoreThan: 0,
                selectAllText: ' Select all',
                selectAllValue: 'multiselect-all',
                selectAllName: false,
                selectAllNumber: true,
                selectAllJustVisible: true,
                enableFiltering: false,
                enableCaseInsensitiveFiltering: false,
                enableFullValueFiltering: false,
                enableClickableOptGroups: false,
                enableCollapsibleOptGroups: false,
                filterPlaceholder: 'Search',
                // possible options: 'text', 'value', 'both'
                filterBehavior: 'text',
                includeFilterClearBtn: true,
                preventInputChangeEvent: false,
                nonSelectedText: 'None selected',
                nSelectedText: 'selected',
                allSelectedText: 'All selected',
                numberDisplayed: 3,
                disableIfEmpty: false,
                disabledText: '',
                delimiterText: ', ',
                templates: {
                    button: '<button type="button" class="multiselect dropdown-toggle btn-block text-left" data-toggle="dropdown"><span class="multiselect-selected-text"></span> <b class="caret"></b></button>',
                    ul: '<ul class="multiselect-container dropdown-menu"></ul>',
                    filter: '<li class="multiselect-item multiselect-filter"><div class="input-group"><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span><input class="form-control multiselect-search" type="text"></div></li>',
                    filterClearBtn: '<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="glyphicon glyphicon-remove-circle"></i></button></span>',
                    li: '<li><a tabindex="0"><label></label></a></li>',
                    divider: '<li class="multiselect-item divider"></li>',
                    liGroup: '<li class="multiselect-item multiselect-group"><label></label></li>'
                }
            },

            constructor: Multiselect,

            /**
             * Builds the container of the multiselect.
             */
            buildContainer: function() {
                this.$container = $(this.options.buttonContainer);
                this.$container.on('show.bs.dropdown', this.options.onDropdownShow);
                this.$container.on('hide.bs.dropdown', this.options.onDropdownHide);
                this.$container.on('shown.bs.dropdown', this.options.onDropdownShown);
                this.$container.on('hidden.bs.dropdown', this.options.onDropdownHidden);
            },

            /**
             * Builds the button of the multiselect.
             */
            buildButton: function() {
                this.$button = $(this.options.templates.button).addClass(this.options.buttonClass);
                if (this.$select.attr('class') && this.options.inheritClass) {
                    this.$button.addClass(this.$select.attr('class'));
                }
                // Adopt active state.
                if (this.$select.prop('disabled')) {
                    this.disable();
                }
                else {
                    this.enable();
                }

                // Manually add button width if set.
                if (this.options.buttonWidth && this.options.buttonWidth !== 'auto') {
                    this.$button.css({
                        'width' : '100%', //this.options.buttonWidth,
                        'overflow' : 'hidden',
                        'text-overflow' : 'ellipsis'
                    });
                    this.$container.css({
                        'width': this.options.buttonWidth
                    });
                }

                // Keep the tab index from the select.
                var tabindex = this.$select.attr('tabindex');
                if (tabindex) {
                    this.$button.attr('tabindex', tabindex);
                }

                this.$container.prepend(this.$button);
            },

            /**
             * Builds the ul representing the dropdown menu.
             */
            buildDropdown: function() {

                // Build ul.
                this.$ul = $(this.options.templates.ul);

                if (this.options.dropRight) {
                    this.$ul.addClass('pull-right');
                }

                // Set max height of dropdown menu to activate auto scrollbar.
                if (this.options.maxHeight) {
                    // TODO: Add a class for this option to move the css declarations.
                    this.$ul.css({
                        'max-height': this.options.maxHeight + 'px',
                        'overflow-y': 'auto',
                        'overflow-x': 'hidden'
                    });
                }

                if (this.options.dropUp) {

                    var height = Math.min(this.options.maxHeight, $('option[data-role!="divider"]', this.$select).length*26 + $('option[data-role="divider"]', this.$select).length*19 + (this.options.includeSelectAllOption ? 26 : 0) + (this.options.enableFiltering || this.options.enableCaseInsensitiveFiltering ? 44 : 0));
                    var moveCalc = height + 34;

                    this.$ul.css({
                        'max-height': height + 'px',
                        'overflow-y': 'auto',
                        'overflow-x': 'hidden',
                        'margin-top': "-" + moveCalc + 'px'
                    });
                }

                this.$container.append(this.$ul);
            },

            /**
             * Build the dropdown options and binds all necessary events.
             *
             * Uses createDivider and createOptionValue to create the necessary options.
             */
            buildDropdownOptions: function() {

                this.$select.children().each($.proxy(function(index, element) {

                    var $element = $(element);
                    // Support optgroups and options without a group simultaneously.
                    var tag = $element.prop('tagName')
                        .toLowerCase();

                    if ($element.prop('value') === this.options.selectAllValue) {
                        return;
                    }

                    if (tag === 'optgroup') {
                        this.createOptgroup(element);
                    }
                    else if (tag === 'option') {

                        if ($element.data('role') === 'divider') {
                            this.createDivider();
                        }
                        else {
                            this.createOptionValue(element);
                        }

                    }

                    // Other illegal tags will be ignored.
                }, this));

                // Bind the change event on the dropdown elements.
                $('li:not(.multiselect-group) input', this.$ul).on('change', $.proxy(function(event) {
                    var $target = $(event.target);

                    var checked = $target.prop('checked') || false;
                    var isSelectAllOption = $target.val() === this.options.selectAllValue;

                    // Apply or unapply the configured selected class.
                    if (this.options.selectedClass) {
                        if (checked) {
                            $target.closest('li')
                                .addClass(this.options.selectedClass);
                        }
                        else {
                            $target.closest('li')
                                .removeClass(this.options.selectedClass);
                        }
                    }

                    // Get the corresponding option.
                    var value = $target.val();
                    var $option = this.getOptionByValue(value);

                    var $optionsNotThis = $('option', this.$select).not($option);
                    var $checkboxesNotThis = $('input', this.$container).not($target);

                    if (isSelectAllOption) {

                        if (checked) {
                            this.selectAll(this.options.selectAllJustVisible, true);
                        }
                        else {
                            this.deselectAll(this.options.selectAllJustVisible, true);
                        }
                    }
                    else {
                        if (checked) {
                            $option.prop('selected', true);

                            if (this.options.multiple) {
                                // Simply select additional option.
                                $option.prop('selected', true);
                            }
                            else {
                                // Unselect all other options and corresponding checkboxes.
                                if (this.options.selectedClass) {
                                    $($checkboxesNotThis).closest('li').removeClass(this.options.selectedClass);
                                }

                                $($checkboxesNotThis).prop('checked', false);
                                $optionsNotThis.prop('selected', false);

                                // It's a single selection, so close.
                                this.$button.click();
                            }

                            if (this.options.selectedClass === "active") {
                                $optionsNotThis.closest("a").css("outline", "");
                            }
                        }
                        else {
                            // Unselect option.
                            $option.prop('selected', false);
                        }

                        // To prevent select all from firing onChange: #575
                        this.options.onChange($option, checked);

                        // Do not update select all or optgroups on select all change!
                        this.updateSelectAll();

                        if (this.options.enableClickableOptGroups && this.options.multiple) {
                            this.updateOptGroups();
                        }
                    }

                    this.$select.change();
                    this.updateButtonText();

                    if(this.options.preventInputChangeEvent) {
                        return false;
                    }
                }, this));

                $('li a', this.$ul).on('mousedown', function(e) {
                    if (e.shiftKey) {
                        // Prevent selecting text by Shift+click
                        return false;
                    }
                });

                $('li a', this.$ul).on('touchstart click', $.proxy(function(event) {
                    event.stopPropagation();

                    var $target = $(event.target);

                    if (event.shiftKey && this.options.multiple) {
                        if($target.is("label")){ // Handles checkbox selection manually (see https://github.com/davidstutz/bootstrap-multiselect/issues/431)
                            event.preventDefault();
                            $target = $target.find("input");
                            $target.prop("checked", !$target.prop("checked"));
                        }
                        var checked = $target.prop('checked') || false;

                        if (this.lastToggledInput !== null && this.lastToggledInput !== $target) { // Make sure we actually have a range
                            var from = $target.closest("li").index();
                            var to = this.lastToggledInput.closest("li").index();

                            if (from > to) { // Swap the indices
                                var tmp = to;
                                to = from;
                                from = tmp;
                            }

                            // Make sure we grab all elements since slice excludes the last index
                            ++to;

                            // Change the checkboxes and underlying options
                            var range = this.$ul.find("li").slice(from, to).find("input");

                            range.prop('checked', checked);

                            if (this.options.selectedClass) {
                                range.closest('li')
                                    .toggleClass(this.options.selectedClass, checked);
                            }

                            for (var i = 0, j = range.length; i < j; i++) {
                                var $checkbox = $(range[i]);

                                var $option = this.getOptionByValue($checkbox.val());

                                $option.prop('selected', checked);
                            }
                        }

                        // Trigger the select "change" event
                        $target.trigger("change");
                    }

                    // Remembers last clicked option
                    if($target.is("input") && !$target.closest("li").is(".multiselect-item")){
                        this.lastToggledInput = $target;
                    }

                    $target.blur();
                }, this));

                // Keyboard support.
                this.$container.off('keydown.multiselect').on('keydown.multiselect', $.proxy(function(event) {
                    if ($('input[type="text"]', this.$container).is(':focus')) {
                        return;
                    }

                    if (event.keyCode === 9 && this.$container.hasClass('open')) {
                        this.$button.click();
                    }
                    else {
                        var $items = $(this.$container).find("li:not(.divider):not(.disabled) a").filter(":visible");

                        if (!$items.length) {
                            return;
                        }

                        var index = $items.index($items.filter(':focus'));

                        // Navigation up.
                        if (event.keyCode === 38 && index > 0) {
                            index--;
                        }
                        // Navigate down.
                        else if (event.keyCode === 40 && index < $items.length - 1) {
                            index++;
                        }
                        else if (!~index) {
                            index = 0;
                        }

                        var $current = $items.eq(index);
                        $current.focus();

                        if (event.keyCode === 32 || event.keyCode === 13) {
                            var $checkbox = $current.find('input');

                            $checkbox.prop("checked", !$checkbox.prop("checked"));
                            $checkbox.change();
                        }

                        event.stopPropagation();
                        event.preventDefault();
                    }
                }, this));

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    $("li.multiselect-group input", this.$ul).on("change", $.proxy(function(event) {
                        event.stopPropagation();

                        var $target = $(event.target);
                        var checked = $target.prop('checked') || false;

                        var $li = $(event.target).closest('li');
                        var $group = $li.nextUntil("li.multiselect-group")
                            .not('.multiselect-filter-hidden')
                            .not('.disabled');

                        var $inputs = $group.find("input");

                        var values = [];
                        var $options = [];

                        if (this.options.selectedClass) {
                            if (checked) {
                                $li.addClass(this.options.selectedClass);
                            }
                            else {
                                $li.removeClass(this.options.selectedClass);
                            }
                        }

                        $.each($inputs, $.proxy(function(index, input) {
                            var value = $(input).val();
                            var $option = this.getOptionByValue(value);

                            if (checked) {
                                $(input).prop('checked', true);
                                $(input).closest('li')
                                    .addClass(this.options.selectedClass);

                                $option.prop('selected', true);
                            }
                            else {
                                $(input).prop('checked', false);
                                $(input).closest('li')
                                    .removeClass(this.options.selectedClass);

                                $option.prop('selected', false);
                            }

                            $options.push(this.getOptionByValue(value));
                        }, this))

                        // Cannot use select or deselect here because it would call updateOptGroups again.

                        this.options.onChange($options, checked);

                        this.updateButtonText();
                        this.updateSelectAll();
                    }, this));
                }

                if (this.options.enableCollapsibleOptGroups && this.options.multiple) {
                    $("li.multiselect-group .caret-container", this.$ul).on("click", $.proxy(function(event) {
                        var $li = $(event.target).closest('li');
                        var $inputs = $li.nextUntil("li.multiselect-group")
                            .not('.multiselect-filter-hidden');

                        var visible = true;
                        $inputs.each(function() {
                            visible = visible && $(this).is(':visible');
                        });

                        if (visible) {
                            $inputs.hide()
                                .addClass('multiselect-collapsible-hidden');
                        }
                        else {
                            $inputs.show()
                                .removeClass('multiselect-collapsible-hidden');
                        }
                    }, this));

                    $("li.multiselect-all", this.$ul).css('background', '#f3f3f3').css('border-bottom', '1px solid #eaeaea');
                    $("li.multiselect-all > a > label.checkbox", this.$ul).css('padding', '3px 20px 3px 35px');
                    $("li.multiselect-group > a > input", this.$ul).css('margin', '4px 0px 5px -20px');
                }
            },

            /**
             * Create an option using the given select option.
             *
             * @param {jQuery} element
             */
            createOptionValue: function(element) {
                var $element = $(element);
                if ($element.is(':selected')) {
                    $element.prop('selected', true);
                }

                // Support the label attribute on options.
                var label = this.options.optionLabel(element);
                var classes = this.options.optionClass(element);
                var value = $element.val();
                var inputType = this.options.multiple ? "checkbox" : "radio";

                var $li = $(this.options.templates.li);
                var $label = $('label', $li);
                $label.addClass(inputType);
                $li.addClass(classes);

                if (this.options.enableHTML) {
                    $label.html(" " + label);
                }
                else {
                    $label.text(" " + label);
                }

                var $checkbox = $('<input/>').attr('type', inputType);

                var name = this.options.checkboxName($element);
                if (name) {
                    $checkbox.attr('name', name);
                }

                $label.prepend($checkbox);

                var selected = $element.prop('selected') || false;
                $checkbox.val(value);

                if (value === this.options.selectAllValue) {
                    $li.addClass("multiselect-item multiselect-all");
                    $checkbox.parent().parent()
                        .addClass('multiselect-all');
                }

                $label.attr('title', $element.attr('title'));

                this.$ul.append($li);

                if ($element.is(':disabled')) {
                    $checkbox.attr('disabled', 'disabled')
                        .prop('disabled', true)
                        .closest('a')
                        .attr("tabindex", "-1")
                        .closest('li')
                        .addClass('disabled');
                }

                $checkbox.prop('checked', selected);

                if (selected && this.options.selectedClass) {
                    $checkbox.closest('li')
                        .addClass(this.options.selectedClass);
                }
            },

            /**
             * Creates a divider using the given select option.
             *
             * @param {jQuery} element
             */
            createDivider: function(element) {
                var $divider = $(this.options.templates.divider);
                this.$ul.append($divider);
            },

            /**
             * Creates an optgroup.
             *
             * @param {jQuery} group
             */
            createOptgroup: function(group) {
                var label = $(group).attr("label");
                var value = $(group).attr("value");
                var $li = $('<li class="multiselect-item multiselect-group"><a href="javascript:void(0);"><label><b></b></label></a></li>');

                var classes = this.options.optionClass(group);
                $li.addClass(classes);

                if (this.options.enableHTML) {
                    $('label b', $li).html(" " + label);
                }
                else {
                    $('label b', $li).text(" " + label);
                }

                if (this.options.enableCollapsibleOptGroups && this.options.multiple) {
                    $('a', $li).append('<span class="caret-container"><b class="caret"></b></span>');
                }

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    $('a label', $li).prepend('<input type="checkbox" value="' + value + '"/>');
                }

                if ($(group).is(':disabled')) {
                    $li.addClass('disabled');
                }

                this.$ul.append($li);

                $("option", group).each($.proxy(function($, group) {
                    this.createOptionValue(group);
                }, this))
            },

            /**
             * Build the select all.
             *
             * Checks if a select all has already been created.
             */
            buildSelectAll: function() {
                if (typeof this.options.selectAllValue === 'number') {
                    this.options.selectAllValue = this.options.selectAllValue.toString();
                }

                var alreadyHasSelectAll = this.hasSelectAll();

                if (!alreadyHasSelectAll && this.options.includeSelectAllOption && this.options.multiple
                    && $('option', this.$select).length > this.options.includeSelectAllIfMoreThan) {

                    // Check whether to add a divider after the select all.
                    if (this.options.includeSelectAllDivider) {
                        this.$ul.prepend($(this.options.templates.divider));
                    }

                    var $li = $(this.options.templates.li);
                    $('label', $li).addClass("checkbox");

                    if (this.options.enableHTML) {
                        $('label', $li).html(" " + this.options.selectAllText);
                    }
                    else {
                        $('label', $li).text(" " + this.options.selectAllText);
                    }

                    if (this.options.selectAllName) {
                        $('label', $li).prepend('<input type="checkbox" name="' + this.options.selectAllName + '" />');
                    }
                    else {
                        $('label', $li).prepend('<input type="checkbox" />');
                    }

                    var $checkbox = $('input', $li);
                    $checkbox.val(this.options.selectAllValue);

                    $li.addClass("multiselect-item multiselect-all");
                    $checkbox.parent().parent()
                        .addClass('multiselect-all');

                    this.$ul.prepend($li);

                    $checkbox.prop('checked', false);
                }
            },

            /**
             * Builds the filter.
             */
            buildFilter: function() {

                // Build filter if filtering OR case insensitive filtering is enabled and the number of options exceeds (or equals) enableFilterLength.
                if (this.options.enableFiltering || this.options.enableCaseInsensitiveFiltering) {
                    var enableFilterLength = Math.max(this.options.enableFiltering, this.options.enableCaseInsensitiveFiltering);

                    if (this.$select.find('option').length >= enableFilterLength) {

                        this.$filter = $(this.options.templates.filter);
                        $('input', this.$filter).attr('placeholder', this.options.filterPlaceholder);

                        // Adds optional filter clear button
                        if(this.options.includeFilterClearBtn) {
                            var clearBtn = $(this.options.templates.filterClearBtn);
                            clearBtn.on('click', $.proxy(function(event){
                                clearTimeout(this.searchTimeout);

                                this.$filter.find('.multiselect-search').val('');
                                $('li', this.$ul).show().removeClass('multiselect-filter-hidden');

                                this.updateSelectAll();

                                if (this.options.enableClickableOptGroups && this.options.multiple) {
                                    this.updateOptGroups();
                                }

                            }, this));
                            this.$filter.find('.input-group').append(clearBtn);
                        }

                        this.$ul.prepend(this.$filter);

                        this.$filter.val(this.query).on('click', function(event) {
                            event.stopPropagation();
                        }).on('input keydown', $.proxy(function(event) {
                            // Cancel enter key default behaviour
                            if (event.which === 13) {
                                event.preventDefault();
                            }

                            // This is useful to catch "keydown" events after the browser has updated the control.
                            clearTimeout(this.searchTimeout);

                            this.searchTimeout = this.asyncFunction($.proxy(function() {

                                if (this.query !== event.target.value) {
                                    this.query = event.target.value;

                                    var currentGroup, currentGroupVisible;
                                    $.each($('li', this.$ul), $.proxy(function(index, element) {
                                        var value = $('input', element).length > 0 ? $('input', element).val() : "";
                                        var text = $('label', element).text();

                                        var filterCandidate = '';
                                        if ((this.options.filterBehavior === 'text')) {
                                            filterCandidate = text;
                                        }
                                        else if ((this.options.filterBehavior === 'value')) {
                                            filterCandidate = value;
                                        }
                                        else if (this.options.filterBehavior === 'both') {
                                            filterCandidate = text + '\n' + value;
                                        }

                                        if (value !== this.options.selectAllValue && text) {

                                            // By default lets assume that element is not
                                            // interesting for this search.
                                            var showElement = false;

                                            if (this.options.enableCaseInsensitiveFiltering) {
                                                filterCandidate = filterCandidate.toLowerCase();
                                                this.query = this.query.toLowerCase();
                                            }

                                            if (this.options.enableFullValueFiltering && this.options.filterBehavior !== 'both') {
                                                var valueToMatch = filterCandidate.trim().substring(0, this.query.length);
                                                if (this.query.indexOf(valueToMatch) > -1) {
                                                    showElement = true;
                                                }
                                            }
                                            else if (filterCandidate.indexOf(this.query) > -1) {
                                                showElement = true;
                                            }

                                            // Toggle current element (group or group item) according to showElement boolean.
                                            $(element).toggle(showElement)
                                                .toggleClass('multiselect-filter-hidden', !showElement);

                                            // Differentiate groups and group items.
                                            if ($(element).hasClass('multiselect-group')) {
                                                // Remember group status.
                                                currentGroup = element;
                                                currentGroupVisible = showElement;
                                            }
                                            else {
                                                // Show group name when at least one of its items is visible.
                                                if (showElement) {
                                                    $(currentGroup).show()
                                                        .removeClass('multiselect-filter-hidden');
                                                }

                                                // Show all group items when group name satisfies filter.
                                                if (!showElement && currentGroupVisible) {
                                                    $(element).show()
                                                        .removeClass('multiselect-filter-hidden');
                                                }
                                            }
                                        }
                                    }, this));
                                }

                                this.updateSelectAll();

                                if (this.options.enableClickableOptGroups && this.options.multiple) {
                                    this.updateOptGroups();
                                }

                                this.options.onFiltering(event.target);

                            }, this), 300, this);
                        }, this));
                    }
                }
            },

            /**
             * Unbinds the whole plugin.
             */
            destroy: function() {
                this.$container.remove();
                this.$select.show();

                // reset original state
                this.$select.prop('disabled', this.options.wasDisabled);

                this.$select.data('multiselect', null);
            },

            /**
             * Refreshs the multiselect based on the selected options of the select.
             */
            refresh: function () {
                var inputs = $.map($('li input', this.$ul), $);

                $('option', this.$select).each($.proxy(function (index, element) {
                    var $elem = $(element);
                    var value = $elem.val();
                    var $input;
                    for (var i = inputs.length; 0 < i--; /**/) {
                        if (value !== ($input = inputs[i]).val())
                            continue; // wrong li

                        if ($elem.is(':selected')) {
                            $input.prop('checked', true);

                            if (this.options.selectedClass) {
                                $input.closest('li')
                                    .addClass(this.options.selectedClass);
                            }
                        }
                        else {
                            $input.prop('checked', false);

                            if (this.options.selectedClass) {
                                $input.closest('li')
                                    .removeClass(this.options.selectedClass);
                            }
                        }

                        if ($elem.is(":disabled")) {
                            $input.attr('disabled', 'disabled')
                                .prop('disabled', true)
                                .closest('li')
                                .addClass('disabled');
                        }
                        else {
                            $input.prop('disabled', false)
                                .closest('li')
                                .removeClass('disabled');
                        }
                        break; // assumes unique values
                    }
                }, this));

                this.updateButtonText();
                this.updateSelectAll();

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }
            },

            /**
             * Select all options of the given values.
             *
             * If triggerOnChange is set to true, the on change event is triggered if
             * and only if one value is passed.
             *
             * @param {Array} selectValues
             * @param {Boolean} triggerOnChange
             */
            select: function(selectValues, triggerOnChange) {
                if(!$.isArray(selectValues)) {
                    selectValues = [selectValues];
                }

                for (var i = 0; i < selectValues.length; i++) {
                    var value = selectValues[i];

                    if (value === null || value === undefined) {
                        continue;
                    }

                    var $option = this.getOptionByValue(value);
                    var $checkbox = this.getInputByValue(value);

                    if($option === undefined || $checkbox === undefined) {
                        continue;
                    }

                    if (!this.options.multiple) {
                        this.deselectAll(false);
                    }

                    if (this.options.selectedClass) {
                        $checkbox.closest('li')
                            .addClass(this.options.selectedClass);
                    }

                    $checkbox.prop('checked', true);
                    $option.prop('selected', true);

                    if (triggerOnChange) {
                        this.options.onChange($option, true);
                    }
                }

                this.updateButtonText();
                this.updateSelectAll();

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }
            },

            /**
             * Clears all selected items.
             */
            clearSelection: function () {
                this.deselectAll(false);
                this.updateButtonText();
                this.updateSelectAll();

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }
            },

            /**
             * Deselects all options of the given values.
             *
             * If triggerOnChange is set to true, the on change event is triggered, if
             * and only if one value is passed.
             *
             * @param {Array} deselectValues
             * @param {Boolean} triggerOnChange
             */
            deselect: function(deselectValues, triggerOnChange) {
                if(!$.isArray(deselectValues)) {
                    deselectValues = [deselectValues];
                }

                for (var i = 0; i < deselectValues.length; i++) {
                    var value = deselectValues[i];

                    if (value === null || value === undefined) {
                        continue;
                    }

                    var $option = this.getOptionByValue(value);
                    var $checkbox = this.getInputByValue(value);

                    if($option === undefined || $checkbox === undefined) {
                        continue;
                    }

                    if (this.options.selectedClass) {
                        $checkbox.closest('li')
                            .removeClass(this.options.selectedClass);
                    }

                    $checkbox.prop('checked', false);
                    $option.prop('selected', false);

                    if (triggerOnChange) {
                        this.options.onChange($option, false);
                    }
                }

                this.updateButtonText();
                this.updateSelectAll();

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }
            },

            /**
             * Selects all enabled & visible options.
             *
             * If justVisible is true or not specified, only visible options are selected.
             *
             * @param {Boolean} justVisible
             * @param {Boolean} triggerOnSelectAll
             */
            selectAll: function (justVisible, triggerOnSelectAll) {

                var justVisible = typeof justVisible === 'undefined' ? true : justVisible;
                var allLis = $("li:not(.divider):not(.disabled):not(.multiselect-group)", this.$ul);
                var visibleLis = $("li:not(.divider):not(.disabled):not(.multiselect-group):not(.multiselect-filter-hidden):not(.multiselect-collapisble-hidden)", this.$ul).filter(':visible');

                if(justVisible) {
                    $('input:enabled' , visibleLis).prop('checked', true);
                    visibleLis.addClass(this.options.selectedClass);

                    $('input:enabled' , visibleLis).each($.proxy(function(index, element) {
                        var value = $(element).val();
                        var option = this.getOptionByValue(value);
                        $(option).prop('selected', true);
                    }, this));
                }
                else {
                    $('input:enabled' , allLis).prop('checked', true);
                    allLis.addClass(this.options.selectedClass);

                    $('input:enabled' , allLis).each($.proxy(function(index, element) {
                        var value = $(element).val();
                        var option = this.getOptionByValue(value);
                        $(option).prop('selected', true);
                    }, this));
                }

                $('li input[value="' + this.options.selectAllValue + '"]', this.$ul).prop('checked', true);

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }

                if (triggerOnSelectAll) {
                    this.options.onSelectAll();
                }
            },

            /**
             * Deselects all options.
             *
             * If justVisible is true or not specified, only visible options are deselected.
             *
             * @param {Boolean} justVisible
             */
            deselectAll: function (justVisible, triggerOnDeselectAll) {

                var justVisible = typeof justVisible === 'undefined' ? true : justVisible;
                var allLis = $("li:not(.divider):not(.disabled):not(.multiselect-group)", this.$ul);
                var visibleLis = $("li:not(.divider):not(.disabled):not(.multiselect-group):not(.multiselect-filter-hidden):not(.multiselect-collapisble-hidden)", this.$ul).filter(':visible');

                if(justVisible) {
                    $('input[type="checkbox"]:enabled' , visibleLis).prop('checked', false);
                    visibleLis.removeClass(this.options.selectedClass);

                    $('input[type="checkbox"]:enabled' , visibleLis).each($.proxy(function(index, element) {
                        var value = $(element).val();
                        var option = this.getOptionByValue(value);
                        $(option).prop('selected', false);
                    }, this));
                }
                else {
                    $('input[type="checkbox"]:enabled' , allLis).prop('checked', false);
                    allLis.removeClass(this.options.selectedClass);

                    $('input[type="checkbox"]:enabled' , allLis).each($.proxy(function(index, element) {
                        var value = $(element).val();
                        var option = this.getOptionByValue(value);
                        $(option).prop('selected', false);
                    }, this));
                }

                $('li input[value="' + this.options.selectAllValue + '"]', this.$ul).prop('checked', false);

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }

                if (triggerOnDeselectAll) {
                    this.options.onDeselectAll();
                }
            },

            /**
             * Rebuild the plugin.
             *
             * Rebuilds the dropdown, the filter and the select all option.
             */
            rebuild: function() {
                this.$ul.html('');

                // Important to distinguish between radios and checkboxes.
                this.options.multiple = this.$select.attr('multiple') === "multiple";

                this.buildSelectAll();
                this.buildDropdownOptions();
                this.buildFilter();

                this.updateButtonText();
                this.updateSelectAll(true);

                if (this.options.enableClickableOptGroups && this.options.multiple) {
                    this.updateOptGroups();
                }

                if (this.options.disableIfEmpty && $('option', this.$select).length <= 0) {
                    this.disable();
                }
                else {
                    this.enable();
                }

                if (this.options.dropRight) {
                    this.$ul.addClass('pull-right');
                }
            },

            /**
             * The provided data will be used to build the dropdown.
             */
            dataprovider: function(dataprovider) {

                var groupCounter = 0;
                var $select = this.$select.empty();

                $.each(dataprovider, function (index, option) {
                    var $tag;

                    if ($.isArray(option.children)) { // create optiongroup tag
                        groupCounter++;

                        $tag = $('<optgroup/>').attr({
                            label: option.label || 'Group ' + groupCounter,
                            disabled: !!option.disabled
                        });

                        forEach(option.children, function(subOption) { // add children option tags
                            var attributes = {
                                value: subOption.value,
                                label: subOption.label || subOption.value,
                                title: subOption.title,
                                selected: !!subOption.selected,
                                disabled: !!subOption.disabled
                            };

                            //Loop through attributes object and add key-value for each attribute
                            for (var key in subOption.attributes) {
                                attributes['data-' + key] = subOption.attributes[key];
                            }
                            //Append original attributes + new data attributes to option
                            $tag.append($('<option/>').attr(attributes));
                        });
                    }
                    else {

                        var attributes = {
                            'value': option.value,
                            'label': option.label || option.value,
                            'title': option.title,
                            'class': option.class,
                            'selected': !!option.selected,
                            'disabled': !!option.disabled
                        };
                        //Loop through attributes object and add key-value for each attribute
                        for (var key in option.attributes) {
                            attributes['data-' + key] = option.attributes[key];
                        }
                        //Append original attributes + new data attributes to option
                        $tag = $('<option/>').attr(attributes);

                        $tag.text(option.label || option.value);
                    }

                    $select.append($tag);
                });

                this.rebuild();
            },

            /**
             * Enable the multiselect.
             */
            enable: function() {
                this.$select.prop('disabled', false);
                this.$button.prop('disabled', false)
                    .removeClass('disabled');
            },

            /**
             * Disable the multiselect.
             */
            disable: function() {
                this.$select.prop('disabled', true);
                this.$button.prop('disabled', true)
                    .addClass('disabled');
            },

            /**
             * Set the options.
             *
             * @param {Array} options
             */
            setOptions: function(options) {
                this.options = this.mergeOptions(options);
            },

            /**
             * Merges the given options with the default options.
             *
             * @param {Array} options
             * @returns {Array}
             */
            mergeOptions: function(options) {
                return $.extend(true, {}, this.defaults, this.options, options);
            },

            /**
             * Checks whether a select all checkbox is present.
             *
             * @returns {Boolean}
             */
            hasSelectAll: function() {
                return $('li.multiselect-all', this.$ul).length > 0;
            },

            /**
             * Update opt groups.
             */
            updateOptGroups: function() {
                var $groups = $('li.multiselect-group', this.$ul)
                var selectedClass = this.options.selectedClass;

                $groups.each(function() {
                    var $options = $(this).nextUntil('li.multiselect-group')
                        .not('.multiselect-filter-hidden')
                        .not('.disabled');

                    var checked = true;
                    $options.each(function() {
                        var $input = $('input', this);

                        if (!$input.prop('checked')) {
                            checked = false;
                        }
                    });

                    if (selectedClass) {
                        if (checked) {
                            $(this).addClass(selectedClass);
                        }
                        else {
                            $(this).removeClass(selectedClass);
                        }
                    }

                    $('input', this).prop('checked', checked);
                });
            },

            /**
             * Updates the select all checkbox based on the currently displayed and selected checkboxes.
             */
            updateSelectAll: function(notTriggerOnSelectAll) {
                if (this.hasSelectAll()) {
                    var allBoxes = $("li:not(.multiselect-item):not(.multiselect-filter-hidden):not(.multiselect-group):not(.disabled) input:enabled", this.$ul);
                    var allBoxesLength = allBoxes.length;
                    var checkedBoxesLength = allBoxes.filter(":checked").length;
                    var selectAllLi  = $("li.multiselect-all", this.$ul);
                    var selectAllInput = selectAllLi.find("input");

                    if (checkedBoxesLength > 0 && checkedBoxesLength === allBoxesLength) {
                        selectAllInput.prop("checked", true);
                        selectAllLi.addClass(this.options.selectedClass);
                    }
                    else {
                        selectAllInput.prop("checked", false);
                        selectAllLi.removeClass(this.options.selectedClass);
                    }
                }
            },

            /**
             * Update the button text and its title based on the currently selected options.
             */
            updateButtonText: function() {
                var options = this.getSelected();

                // First update the displayed button text.
                if (this.options.enableHTML) {
                    $('.multiselect .multiselect-selected-text', this.$container).html(this.options.buttonText(options, this.$select));
                }
                else {
                    $('.multiselect .multiselect-selected-text', this.$container).text(this.options.buttonText(options, this.$select));
                }

                // Now update the title attribute of the button.
                $('.multiselect', this.$container).attr('title', this.options.buttonTitle(options, this.$select));
            },

            /**
             * Get all selected options.
             *
             * @returns {jQUery}
             */
            getSelected: function() {
                return $('option', this.$select).filter(":selected");
            },

            /**
             * Gets a select option by its value.
             *
             * @param {String} value
             * @returns {jQuery}
             */
            getOptionByValue: function (value) {

                var options = $('option', this.$select);
                var valueToCompare = value.toString();

                for (var i = 0; i < options.length; i = i + 1) {
                    var option = options[i];
                    if (option.value === valueToCompare) {
                        return $(option);
                    }
                }
            },

            /**
             * Get the input (radio/checkbox) by its value.
             *
             * @param {String} value
             * @returns {jQuery}
             */
            getInputByValue: function (value) {

                var checkboxes = $('li input:not(.multiselect-search)', this.$ul);
                var valueToCompare = value.toString();

                for (var i = 0; i < checkboxes.length; i = i + 1) {
                    var checkbox = checkboxes[i];
                    if (checkbox.value === valueToCompare) {
                        return $(checkbox);
                    }
                }
            },

            /**
             * Used for knockout integration.
             */
            updateOriginalOptions: function() {
                this.originalOptions = this.$select.clone()[0].options;
            },

            asyncFunction: function(callback, timeout, self) {
                var args = Array.prototype.slice.call(arguments, 3);
                return setTimeout(function() {
                    callback.apply(self || window, args);
                }, timeout);
            },

            setAllSelectedText: function(allSelectedText) {
                this.options.allSelectedText = allSelectedText;
                this.updateButtonText();
            }
        };

        $.fn.multiselect = function(option, parameter, extraOptions) {
            return this.each(function() {
                var data = $(this).data('multiselect');
                var options = typeof option === 'object' && option;

                // Initialize the multiselect.
                if (!data) {
                    data = new Multiselect(this, options);
                    $(this).data('multiselect', data);
                }

                // Call multiselect method.
                if (typeof option === 'string') {
                    data[option](parameter, extraOptions);

                    if (option === 'destroy') {
                        $(this).data('multiselect', false);
                    }
                }
            });
        };

        $.fn.multiselect.Constructor = Multiselect;

        $(function() {
            $("select[data-role=multiselect]").multiselect();
        });

    }(window.jQuery);
</script>
</body>
</html>