<script>
    if (dhis2.dsr){
        function calculateReportIndicators() {
            $('input[name="indicatorFormula"]').css('border','none'); $('input[name="indicatorFormula"]').css('background-color','#FFFFFF'); $('input[name="indicatorFormula"]').css('font-weight','500');
            $('input[name="indicatorFormula"]').css('height','2em');
            $('input[name ="indicatorFormula"]').each(function (i, form) {
                var unReplacedFormula = $(this).attr('indicatorFormula');
                var elementComboArr = unReplacedFormula.replace("/",",").split("(").join("").split(")").join("").split(",")[0].split("+");
                var sum = 0;
                for (var count = 0; count < elementComboArr.length; count++) {
                    if (elementComboArr[count].length > 18) {
                        var toReplace='';
                        var elementCombo = elementComboArr[count].split(".");
                        // console.log('($("span[data-co='+elementCombo[1].replace("}","")+'][data-de='+elementCombo[0].replace("#{","")+']").text())');
                        var spanValue = parseInt($("span[data-co="+elementCombo[1].replace("}","")+"][data-de="+elementCombo[0].replace("#{","")+"]").text());
                        if (isNaN(spanValue)=== false) {
                            sum = spanValue;
                        } else {
                            sum = 0;
                        }
                        toReplace += elementCombo[0]+'.'+elementCombo[1];
                        unReplacedFormula = unReplacedFormula.replace(toReplace, sum);
                    }
                }
                console.log(unReplacedFormula);
                if (parseInt(eval(unReplacedFormula))){
                    $('#'+form.id).val(parseInt(eval(unReplacedFormula)));
                }
            });
        }
        $(document).ready(function(){
            calculateReportIndicators();
        });
    }else {
        dhis2.util.on('dhis2.de.event.dataValuesLoaded', function () {
            $('input[name="indicatorFormula"]').css('background-color','#EEEEEE'); $('input[name="indicatorFormula"]').css('font-weight','500');
            $('input[name="indicatorFormula"]').css('height','2em');
            $('input[name="indicatorFormula"]').css('border','1px grey solid'); $('input[name="indicatorFormula"]').css('text-align','center');
            calculateIndicatorValue();
            addListerners();
        });

        function addListerners(){
            $('input[name ="entryfield"]').each(function (i) {
                $(this).change(function () {
                    //codes for on changes
                    calculateIndicatorValue();
                });
            });
        }

        function validateData(formula) {
            var valuesToSum = [];
            formula.split('/')[0].substring(1, formula.split('/')[0].length -1).split('+').forEach(function (value) {
                if (isNaN(eval(value)) === true) {
                    // no value
                } else {
                    valuesToSum.push(eval(value));
                }
            });
            var theSum = 0;
            valuesToSum.forEach(function (value) {
                theSum += value;
            });

            return theSum;
        }

        function calculateIndicatorValue() {
            $('input[name ="indicatorFormula"]').each( function (i, form) {
                var unReplacedFormula = $(this).attr('indicatorFormula');
                var newFormula = unReplacedFormula;
                unReplacedFormula.split("/").forEach(function(entryStr){
                    if (entryStr.length > 18 && entryStr.length < 30 ) {
                        if (entryStr.indexOf("*") > 1) {
                            newFormula = newFormula.replace(entryStr.split("*")[0].split("(").join("").split(")").join(""), 'Number($("#'+entryStr.split("*")[0].split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                        } else {
                            newFormula = newFormula.replace(entryStr.split("(").join("").split(")").join(""),'Number($("#'+entryStr.split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                        }
                    } else if(entryStr.length > 30) {
                        entryStr.split("+").forEach(function(entryStr2){
                            if (entryStr2.indexOf("*") > 1) {
                                newFormula = newFormula.replace(entryStr2.split("*")[0].split("(").join("").split(")").join(""), 'Number($("#'+entryStr2.split("*")[0].split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                            } else {
                                newFormula = newFormula.replace(entryStr2.split("(").join("").split(")").join(""),'Number($("#'+entryStr2.split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                            }
                        })
                    }
                });

                if (newFormula !== undefined) {
                    // validate
                    var theNewFormula = newFormula.split("# ").join("#").split(" -").join("-").replace("  ","").replace(/(?:\r\n|\r|\n)/g, '');
                    $('#'+form.id).val(parseInt(validateData(theNewFormula)));
                }
            });
        }
    }
</script>
