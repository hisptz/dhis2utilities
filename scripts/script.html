<script>
    if (dhis2.dsr){
        function calculateReportIndicators() {
            $('input[name="indicatorFormula"]').css('border','none'); $('input[name="indicatorFormula"]').css('background-color','#FFFFFF'); $('input[name="indicatorFormula"]').css('font-weight','500');
            $('input[name ="indicatorFormula"]').each(function (i, form) {
                var unReplacedFormula = $(this).attr('indicatorFormula');
                var elementComboArr = unReplacedFormula.replace("/",",").split("(").join("").split(")").join("").split(",")[0].split("+")
                var sum = 0;
                for (var count = 0; count < elementComboArr.length; count++) {
                    if (elementComboArr[count].length > 18) {
                        var toReplace='';
                        var elementCombo = elementComboArr[count].split(".");
                        if (isNaN(parseInt($("span[data-co="+elementCombo[1].replace("}","")+"][data-de="+elementCombo[0].replace("#{","")+"]").text()))=== false) {
                            sum += parseInt($("span[data-co="+elementCombo[1].replace("}","")+"][data-de="+elementCombo[0].replace("#{","")+"]").text());
                            toReplace += elementCombo[0]+'.'+elementCombo[1];
                        }
                        unReplacedFormula = unReplacedFormula.replace(toReplace, sum);
                    }
                }
                if (parseInt(eval(unReplacedFormula))){
                    $('#'+form.id).val(parseInt(eval(unReplacedFormula)));
                }
            });
        }
        $(document).ready(function(){
            calculateReportIndicators();
        });
    }else {
        dhis2.util.on('dhis2.de.event.dataValuesLoaded', function () {
            $('input[name="indicatorFormula"]').css('background-color','#FFFFFF'); $('input[name="indicatorFormula"]').css('font-weight','500'); $('input[name="indicatorFormula"]').css('border','1px grey solid'); $('input[name="indicatorFormula"]').css('text-align','center');
            calculateIndicatorValue();
            addListerners();
        });

        function addListerners(){
            $('input[name ="entryfield"]').each(function (i) {
                $(this).change(function () {
                    //codes for on changes
                    calculateIndicatorValue();
                });
            });
        }

        function calculateIndicatorValue() {
            $('input[name ="indicatorFormula"]').each( function (i, form) {
                var unReplacedFormula = $(this).attr('indicatorFormula');
                var newFormula = unReplacedFormula;
                unReplacedFormula.split("/").forEach(function(entryStr){
                    if (entryStr.length > 18 && entryStr.length < 30 ) {
                        if (entryStr.indexOf("*") > 1) {
                            newFormula = newFormula.replace(entryStr.split("*")[0].split("(").join("").split(")").join(""), 'Number($("#'+entryStr.split("*")[0].split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                        } else {
                            newFormula = newFormula.replace(entryStr.split("(").join("").split(")").join(""),'Number($("#'+entryStr.split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                        }
                    } else if(entryStr.length > 30) {
                        entryStr.split("+").forEach(function(entryStr2){
                            if (entryStr2.indexOf("*") > 1) {
                                newFormula = newFormula.replace(entryStr2.split("*")[0].split("(").join("").split(")").join(""), 'Number($("#'+entryStr2.split("*")[0].split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                            } else {
                                newFormula = newFormula.replace(entryStr2.split("(").join("").split(")").join(""),'Number($("#'+entryStr2.split("(").join("").split(")").join("").split("#{").join("").split("}").join("").replace(".","-")+'-val").val())');
                            }
                        })
                    }
                });

                if (newFormula !== undefined) {
                    if (isNaN(eval("("+newFormula+")")) !== true) {
                        $('#'+form.id).val(eval("("+newFormula+")").toFixed(2));
                    } else {
                        $('#'+form.id).val(0);
                    }
                }
            });
        }
    }
</script>
