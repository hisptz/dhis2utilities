<script>
  if (dhis2.dsr) {
    function calculateReportIndicators() {
      $('input[name="indicatorFormula"]').css("border", "none");
      $('input[name="indicatorFormula"]').css("background-color", "#FFFFFF");
      $('input[name="indicatorFormula"]').css("font-weight", "500");
      $('input[name="indicatorFormula"]').css("height", "2em");
      $('input[name ="indicatorFormula"]').each(function(i, indicatorElement) {
        var unReplacedFormula = $(this).attr("indicatorFormula");
        let expression = $(this).attr("indicatorFormula");
        const formulaPattern = /#\{.+?\}/g;
        expression.match(formulaPattern).forEach(matchedItem => {
          let inputValue = $(
            "span[data-co=" +
              matchedItem.replace(/[#\{\}]/g, "").split(".")[1] +
              "][data-de=" +
              matchedItem.replace(/[#\{\}]/g, "").split(".")[0] +
              "]"
          ).text();
          expression = inputValue
            ? expression.replace(matchedItem, Number(inputValue))
            : expression.replace(matchedItem, 0);
        });
        const indicatorValue = eval(expression);
        if (!isNaN(indicatorValue)) {
          $("#" + indicatorElement.id).val(indicatorValue);
        } else {
          $("#" + indicatorElement.id).val(0);
        }
      });
    }
    $(document).ready(function() {
      calculateReportIndicators();
    });
  } else {
    dhis2.util.on("dhis2.de.event.dataValuesLoaded", function() {
      $('input[name="indicatorFormula"]').css("background-color", "#EEEEEE");
      $('input[name="indicatorFormula"]').css("font-weight", "500");
      $('input[name="indicatorFormula"]').css("height", "2em");
      $('input[name="indicatorFormula"]').css("border", "1px grey solid");
      $('input[name="indicatorFormula"]').css("text-align", "center");
      calculateIndicatorValue();
      addListerners();
    });

    function addListerners() {
      $('input[name ="entryfield"]').each(function(i) {
        $(this).change(function() {
          //codes for on changes
          calculateIndicatorValue();
        });
      });
    }

    function calculateIndicatorValue() {
      $('input[name ="indicatorFormula"]').each(function(i, indicatorElement) {
        let expression = $(this).attr("indicatorFormula");
        const formulaPattern = /#\{.+?\}/g;
        expression.match(formulaPattern).forEach(matchedItem => {
          let inputValue = $(
            "#" +
              matchedItem
                .replace(/[#\{\}]/g, "")
                .split(".")
                .join("-") +
              "-val"
          ).val();
          expression = inputValue
            ? expression.replace(matchedItem, Number(inputValue))
            : expression.replace(matchedItem, 0);
        });
        const indicatorValue = eval(expression);
        if (!isNaN(indicatorValue)) {
          $("#" + indicatorElement.id).val(indicatorValue);
        } else {
          $("#" + indicatorElement.id).val(0);
        }
      });
    }
  }
</script>
