<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css" />
    <script src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.4/build/jquery.datetimepicker.full.js">


    <!-- Bootstrap Date-Picker Plugin -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>

    <style>
        span {
            height: 10px; width: 10px;
        }
        .datepicker {
            top: 200px !important;
        }
        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add animation to "page content" */
        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from { bottom:-100px; opacity:0 }
            to { bottom:0px; opacity:1 }
        }

        @keyframes animatebottom {
            from{ bottom:-100px; opacity:0 }
            to{ bottom:0; opacity:1 }
        }

        #myDiv {
            display: none;
            text-align: center;
        }
        td {
            border: 1px solid #000000;
        }
    </style>
</head>

<body onload="myFunction()" style="margin:0;">
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

</script>
<script>
    $(document).ready(function() {

        $('#example').DataTable();

        $(function () {
            $(".datepicker").remove('style');
            $(".datepicker").css('top', '170px');
            $("#datepicker").datepicker();
        });

        function dateFormat(theDate) {
            var year = theDate.split('-')[0];
            var month = theDate.split('-')[1];
            if (theDate.split('-')[1] === '01') {
                month = 'January';
            } else if (theDate.split('-')[1] === '02') {
                month = 'February';
            } else if (theDate.split('-')[1] === '03') {
                month = 'Mach';
            } else if (theDate.split('-')[1] === '04') {
                month = 'April';
            } else if (theDate.split('-')[1] === '05') {
                month = 'May';
            } else if (theDate.split('-')[1] === '06') {
                month = 'June';
            } else if (theDate.split('-')[1] === '07') {
                month = 'July';
            } else if (theDate.split('-')[1] === '08') {
                month = 'August';
            } else if (theDate.split('-')[1] === '09') {
                month = 'September';
            } else if (theDate.split('-')[1] === '10') {
                month = 'October';
            } else if (theDate.split('-')[1] === '11') {
                month = 'November';
            } else if (theDate.split('-')[1] === '12') {
                month = 'December';
            }
            var day = theDate.split('-')[2].substring(0, 2);
            return month + ', ' + day + ' ' + year;
        }

        var date_input = $('input[name="date"]'); //our date input has the name "date"
        var container = $('.bootstrap-iso form').length > 0 ? $('.bootstrap-iso form').parent() : "body";
        var options = {
            format: 'yyyy-mm-dd',
            container: container,
            todayHighlight: true,
            autoclose: true,
            orientation: "bottom auto"
        };
        date_input.datepicker(options);

//        function getReport(eventUrl) {
//        }

        var orgUnit = dhis2.report.organisationUnit;
        $('#start_date').val('2017-01-01');
        $('#end_date').val('2017-12-31');
        var startDate = '2017-01-01';
        var endDate = '2017-12-31';


        $('#hidden-input').append('<input id="orgId" type="hidden" value="' + orgUnit.id + '">');
        $('#top-heading').remove();
        $('#the_message').remove();
        $('#heading').append('<p id="top-heading">MINISTRY OF HEALTH COMMUNITY DEVELOPMENT GENDER ELDERLY AND CHILDREN ( MOH - Tanzania ) :' + dateFormat(startDate) + ' TO ' + dateFormat(endDate) + '</p>');
        var eventUrl = "https://dhis.hisptz.org/dhis/api/organisationUnits.json?fields=id,name,ancestors[id,name],children~size&filter=level:eq:3&paging=false";
        var eventData; var dataRows = '';
        $.getJSON(eventUrl, function (resp1) {
            eventData = resp1;
            function dateFilter(theDate) {
                var year = theDate.split('-')[0];
                var month = theDate.split('-')[1];
                if (theDate.split('-')[1] === '01') {
                    month = 'January';
                } else if (theDate.split('-')[1] === '02') {
                    month = 'February';
                } else if (theDate.split('-')[1] === '03') {
                    month = 'Mach';
                } else if (theDate.split('-')[1] === '04') {
                    month = 'April';
                } else if (theDate.split('-')[1] === '05') {
                    month = 'May';
                } else if (theDate.split('-')[1] === '06') {
                    month = 'June';
                } else if (theDate.split('-')[1] === '07') {
                    month = 'July';
                } else if (theDate.split('-')[1] === '08') {
                    month = 'August';
                } else if (theDate.split('-')[1] === '09') {
                    month = 'September';
                } else if (theDate.split('-')[1] === '10') {
                    month = 'October';
                } else if (theDate.split('-')[1] === '11') {
                    month = 'November';
                } else if (theDate.split('-')[1] === '12') {
                    month = 'December';
                }
                var day = theDate.split('-')[2].substring(0, 2);
                return month + ', ' + day + ' ' + year;
            }

            var arr = []; var checkStr = '';
            if (eventData.length !== 0) {
                eventData.organisationUnits.forEach(function (val) {
                    if (checkStr.indexOf(val.ancestors[1].id + '.' + val.id) == -1) {
                        arr.push(val.ancestors[1].id + '.' + val.id);
                        checkStr += val.ancestors[1].id + '.' + val.id + ',';
                    }
                });
                var urlSqlView = "https://dhis.hisptz.org/dhis/api/sqlViews/rBpcZ9KVveF/data.json?var=startDate:" + startDate + "&var=endDate:" + endDate;

                console.log('The event url is ' + urlSqlView);
                $.getJSON(urlSqlView, function (facilitiesObj) {
                    var dqaRes = facilitiesObj;
                    arr.forEach(function (ancestor) {
                        var serialNumber = 1;
                        eventData.organisationUnits.forEach(function (val, index) {
                            if(val.ancestors[1].id === ancestor.split('.')[0] && val.id === ancestor.split('.')[1]) {
                                var count = 0;
                                Object.keys(dqaRes.rows).forEach(function (key) {
                                    if (dqaRes.rows[key][5] === val.id) {
                                        count ++;
                                    }
                                });
                                var percentage = ((parseFloat(count)/parseFloat(val.children)) * 100).toFixed(2);
                                dataRows = '<tr class="rows_added"><td>'+(index+1)+'</td><td>' + val.ancestors[1].name + '</td><td>' + val.name + '</td><td>' + count+'</td><td>' + val.children +'</td><td>' + percentage + '</td></tr>';
                                console.log("The first Data Row" + dataRows);
                                $('#tbodyId').append(dataRows);
                                serialNumber ++;
                            }
                        });
                    });
                });
            } else {
                dataRows += '<tr class="rows_added"><td><p style="color: #c12003;">No data available for the selected period range</p></td></tr>';
                $('#tbodyId').append(dataRows);
            }
            $('.datepicker').css('top', '200px !important');
        });

        $('#report-btn').click(function (e) {
            document.getElementById("loader").style.display = "block";
            document.getElementById("myDiv").style.display = "none";

            setTimeout(showPage, 1200);

            function showPage() {
                document.getElementById("loader").style.display = "none";
                document.getElementById("myDiv").style.display = "block";
            }
            var startDate = $('#start_date').val();
            var endDate = $('#end_date').val();
            var id = $('#orgId').val();
            $('#top-heading').remove();
            $('.rows_added').remove();
            function dateFormat(theDate) {
                var year = theDate.split('-')[0];
                var month = theDate.split('-')[1];
                if (theDate.split('-')[1] === '01') {
                    month = 'January';
                } else if (theDate.split('-')[1] === '02') {
                    month = 'February';
                } else if (theDate.split('-')[1] === '03') {
                    month = 'Mach';
                } else if (theDate.split('-')[1] === '04') {
                    month = 'April';
                } else if (theDate.split('-')[1] === '05') {
                    month = 'May';
                } else if (theDate.split('-')[1] === '06') {
                    month = 'June';
                } else if (theDate.split('-')[1] === '07') {
                    month = 'July';
                } else if (theDate.split('-')[1] === '08') {
                    month = 'August';
                } else if (theDate.split('-')[1] === '09') {
                    month = 'September';
                } else if (theDate.split('-')[1] === '10') {
                    month = 'October';
                } else if (theDate.split('-')[1] === '11') {
                    month = 'November';
                } else if (theDate.split('-')[1] === '12') {
                    month = 'December';
                }
                var day = theDate.split('-')[2].substring(0, 2);
                return month + ', ' + day + ' ' + year;
            }
            $('#heading').append('<p id="top-heading">MINISTRY OF HEALTH COMMUNITY DEVELOPMENT GENDER ELDERLY AND CHILDREN ( MOH - Tanzania ) :' + startDate + ' TO ' + endDate + '</p>');
            var eventUrl = "https://dhis.hisptz.org/dhis/api/organisationUnits.json?fields=id,name,ancestors[id,name],children~size&filter=level:eq:3&paging=false";
            // getReportData(eventUrl);
            var eventData;
            $.getJSON(eventUrl, function (resp1) {
                eventData = resp1;
                function dateFilter(theDate) {
                    var year = theDate.split('-')[0];
                    var month = theDate.split('-')[1];
                    if (theDate.split('-')[1] === '01') {
                        month = 'January';
                    } else if (theDate.split('-')[1] === '02') {
                        month = 'February';
                    } else if (theDate.split('-')[1] === '03') {
                        month = 'Mach';
                    } else if (theDate.split('-')[1] === '04') {
                        month = 'April';
                    } else if (theDate.split('-')[1] === '05') {
                        month = 'May';
                    } else if (theDate.split('-')[1] === '06') {
                        month = 'June';
                    } else if (theDate.split('-')[1] === '07') {
                        month = 'July';
                    } else if (theDate.split('-')[1] === '08') {
                        month = 'August';
                    } else if (theDate.split('-')[1] === '09') {
                        month = 'September';
                    } else if (theDate.split('-')[1] === '10') {
                        month = 'October';
                    } else if (theDate.split('-')[1] === '11') {
                        month = 'November';
                    } else if (theDate.split('-')[1] === '12') {
                        month = 'December';
                    }
                    var day = theDate.split('-')[2].substring(0, 2);
                    return month + ', ' + day + ' ' + year;
                }

                var eventData;
                var dataRows = '';
                $.getJSON(eventUrl, function (resp1) {
                    eventData = resp1;
                    function dateFilter(theDate) {
                        var year = theDate.split('-')[0];
                        var month = theDate.split('-')[1];
                        if (theDate.split('-')[1] === '01') {
                            month = 'January';
                        } else if (theDate.split('-')[1] === '02') {
                            month = 'February';
                        } else if (theDate.split('-')[1] === '03') {
                            month = 'Mach';
                        } else if (theDate.split('-')[1] === '04') {
                            month = 'April';
                        } else if (theDate.split('-')[1] === '05') {
                            month = 'May';
                        } else if (theDate.split('-')[1] === '06') {
                            month = 'June';
                        } else if (theDate.split('-')[1] === '07') {
                            month = 'July';
                        } else if (theDate.split('-')[1] === '08') {
                            month = 'August';
                        } else if (theDate.split('-')[1] === '09') {
                            month = 'September';
                        } else if (theDate.split('-')[1] === '10') {
                            month = 'October';
                        } else if (theDate.split('-')[1] === '11') {
                            month = 'November';
                        } else if (theDate.split('-')[1] === '12') {
                            month = 'December';
                        }
                        var day = theDate.split('-')[2].substring(0, 2);
                        return month + ', ' + day + ' ' + year;
                    }

                    var arr = [];
                    var checkStr = '';
                    if (eventData.length !== 0) {
                        eventData.organisationUnits.forEach(function (val) {
                            if (checkStr.indexOf(val.ancestors[1].id + '.' + val.id) == -1) {
                                arr.push(val.ancestors[1].id + '.' + val.id);
                                checkStr += val.ancestors[1].id + '.' + val.id + ',';
                            }
                        });
                        var urlSqlView = "https://dhis.hisptz.org/dhis/api/sqlViews/rBpcZ9KVveF/data.json?var=startDate:" + startDate + "&var=endDate:" + endDate;

                        console.log('The event url is ' + urlSqlView);
                        $.getJSON(urlSqlView, function (facilitiesObj) {
                            var dqaRes = facilitiesObj;
                            arr.forEach(function (ancestor) {
                                var serialNumber = 1;
                                eventData.organisationUnits.forEach(function (val, index) {
                                    if (val.ancestors[1].id === ancestor.split('.')[0] && val.id === ancestor.split('.')[1]) {
                                        var count = 0;
                                        Object.keys(dqaRes.rows).forEach(function (key) {
                                            if (dqaRes.rows[key][5] === val.id) {
                                                count++;
                                            }
                                        });
                                        var percentage = ((parseFloat(count) / parseFloat(val.children)) * 100).toFixed(2);
                                        dataRows = '<tr class="rows_added"><td>'+(index+1)+'</td><td>' + val.ancestors[1].name + '</td><td>' + val.name + '</td><td>' + count+'</td><td>' + val.children +'</td><td>' + percentage + '</td></tr>';
                                        console.log("The first Data Row" + dataRows);
                                        $('#tbodyId').append(dataRows);
                                        serialNumber++;
                                    }
                                });
                            });
                        });
                    } else {
                        dataRows += '<tr class="rows_added"><td><p style="color: #c12003;">No data available for the selected period range</p></td></tr>';
                        $('#tbodyId').append(dataRows);
                    }
                    $('.datepicker').css('top', '200px !important');
                });
            });

                $("#btnExport").click(function (e) {
            e.preventDefault();

            //getting data from our table
            var data_type = 'data:application/vnd.ms-excel';
            var table_div = document.getElementById('table_wrapper');
            var table_html = table_div.outerHTML.replace(/ /g, '%20');

            var a = document.createElement('a');
            a.href = data_type + ', ' + table_html;
            a.download = 'exported_table_' + Math.floor((Math.random() * 9999999) + 1000000) + '.xls';
            a.click();
        });
        });
    });
</script>
<br />
<br />
<div id="loader"></div>
<div class="col-md-12" style="margin-bottom: 40px; display:none;"id="myDiv" class="animate-bottom">
    <div class="row">
        <div class="container">
            <br />
            <div class="row">
                <div class="form-group"> <!-- Date input -->
                    <div id="hidden-input"></div>
                    <!--<div id="datepicker-div" style="position: relative;"><input id="datepicker"></div>-->
                    <div style="display: inline-block"><label class="control-label">Start Date</label><input class="form-control" style="width: 150px;" height="25px" name="date" id="start_date" placeholder="YYYY-MM-DD" type="text"/></div>
                    <div style="display: inline-block"><label class="control-label">End Date</label><input class="form-control" style="width: 150px;" height="25px" name="date" id="end_date" placeholder="YYYY-MM-DD" type="text"/></div>
                    <div style="display: inline-block"><button class="btn" id="report-btn" name="submit">Change Date</button></div>
                </div>
            </div>
        </div>
    </div>
    <div class='row'>
        <div class='col-md-12' id="heading" style='text-align:center;font-weight:bolder;'></div>
        <div class='col-md-12' id="icon">
            <div class='row' style='text-align:center;'>
                <div class='col-md-5'>
                </div>
                <div class='col-md-2'>
                    <a href='#' class='thumbnail'
                       style='width:50px!important;padding:10px;font-weight:bolder;position:relative;margin: auto;top: 0;left: 0;right: 0;bottom: 0;border: 0px solid #ffffff!important;border-radius: 0px!important;-webkit-box-shadow: 0 0px 0px rgba(0,0,0,.075)!important;box-shadow: 0 0px 0px rgba(0,0,0,.075)!important;'><img
                            class=''
                            src='https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Coat_of_arms_of_Tanzania.svg/30px-Coat_of_arms_of_Tanzania.svg.png'/></a>
                </div>
                <div class='col-md-5'>
                </div>
            </div>
        </div>
    </div>
    <div  class="row">
        <button id="btnExport" class="pull-right" style="margin-right: 28px;">Download as Excel</button>
    </div>
    <div class='col-md-12' style="">
        <div id="message"></div>
    </div>
    <div class='col-md-12' style="">
        <div id="table_wrapper">
            <table id="" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Region</th>
                    <th>Council</th>
                    <th>Assessed Facilities</th>
                    <th>Total Facilities</th>
                    <th>%</th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                    <th>#</th>
                    <th>Region</th>
                    <th>Council</th>
                    <th>Assessed Facilities</th>
                    <th>Total Facilities</th>
                    <th>%</th>
                </tr>
                </tfoot>
                <tbody id="tbodyId">

                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    var myVar;

    function myFunction() {
        myVar = setTimeout(showPage, 2000);
    }

    function showPage() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("myDiv").style.display = "block";
    }
</script>


</body>

</html>